<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Tables - Excel Uploader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .status-processed {
            color: #28a745;
        }
        .status-pending {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-list"></i> Available Tables</h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <button class="btn btn-primary" onclick="loadTables()">
                                    <i class="fas fa-refresh"></i> Refresh Tables
                                </button>
                            </div>
                        </div>
                        
                        <div id="tablesContent">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Loading tables...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadTables() {
            const tablesContent = document.getElementById('tablesContent');
            
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    tablesContent.innerHTML = '<div class="alert alert-danger">Authentication required. Please log in first.</div>';
                    return;
                }
                
                tablesContent.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading tables...</div>';
                
                const response = await fetch('/api/home/data', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const tables = await response.json();
                    displayTables(tables);
                } else {
                    const error = await response.json();
                    tablesContent.innerHTML = `<div class="alert alert-danger">Error: ${error.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.error('Error loading tables:', error);
                tablesContent.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }
        
        function displayTables(tables) {
            const tablesContent = document.getElementById('tablesContent');
            
            if (!tables || tables.length === 0) {
                tablesContent.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No tables found. 
                        <a href="/upload.html" class="alert-link">Create a new table</a> to get started.
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="row">
                    <div class="col-12">
                        <h5>Found ${tables.length} table(s):</h5>
                    </div>
                </div>
            `;
            
            tables.forEach(table => {
                const statusClass = table.isProcessed ? 'status-processed' : 'status-pending';
                const statusIcon = table.isProcessed ? 'fas fa-check-circle' : 'fas fa-clock';
                const statusText = table.isProcessed ? 'Processed' : 'Pending';
                
                html += `
                    <div class="table-card p-3">
                        <div class="row">
                            <div class="col-md-2">
                                <strong>ID:</strong> ${table.id}
                            </div>
                            <div class="col-md-3">
                                <strong>Name:</strong> ${table.tableName}
                            </div>
                            <div class="col-md-3">
                                <strong>File:</strong> ${table.fileName}
                            </div>
                            <div class="col-md-2">
                                <strong>Status:</strong> 
                                <span class="${statusClass}">
                                    <i class="${statusIcon}"></i> ${statusText}
                                </span>
                            </div>
                            <div class="col-md-2">
                                <strong>Rows:</strong> ${table.rowCount}
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <strong>Uploaded:</strong> ${new Date(table.uploadDate).toLocaleString()}
                            </div>
                            <div class="col-md-6">
                                <strong>By:</strong> ${table.uploadedBy}
                            </div>
                        </div>
                        ${table.description ? `
                            <div class="row mt-1">
                                <div class="col-12">
                                    <strong>Description:</strong> ${table.description}
                                </div>
                            </div>
                        ` : ''}
                        <div class="row mt-2">
                            <div class="col-12">
                                <button class="btn btn-sm btn-outline-primary" onclick="copyTableId(${table.id})">
                                    <i class="fas fa-copy"></i> Copy ID
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="viewTable('${table.tableName}')">
                                    <i class="fas fa-eye"></i> View Data
                                </button>
                                <a href="/debug-insert.html?tableId=${table.id}" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-upload"></i> Insert Data
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            tablesContent.innerHTML = html;
        }
        
        function copyTableId(tableId) {
            navigator.clipboard.writeText(tableId.toString()).then(() => {
                // Show a temporary success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-success');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-primary');
                }, 2000);
            });
        }
        
        function viewTable(tableName) {
            // Open view-table endpoint in a new tab
            const token = localStorage.getItem('authToken');
            if (token) {
                const url = `/api/home/view-table?tableName=${encodeURIComponent(tableName)}`;
                window.open(url, '_blank');
            }
        }
        
        // Auto-load tables on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTables();
        });
    </script>
</body>
</html>
