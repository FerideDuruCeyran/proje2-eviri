<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Uploader - Authentication Test</title>
    <link rel="stylesheet" href="css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-file-excel"></i> Excel Uploader - Authentication Test</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Authentication Test</h2>
                </div>
                <div class="card-body">
                    <div id="testResults">
                        <p>Running authentication tests...</p>
                    </div>
                    
                    <div class="form-group">
                        <button onclick="runTests()" class="btn btn-primary">
                            <i class="fas fa-play"></i> Run Tests
                        </button>
                        <button onclick="clearResults()" class="btn btn-secondary">
                            <i class="fas fa-trash"></i> Clear Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/site.js"></script>
    <script>
        async function runTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<p>Running tests...</p>';
            
            const results = [];
            
            // Test 1: Health endpoint (no auth required)
            try {
                const healthResponse = await fetch('/api/home/health');
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    results.push(`✅ Health check passed: ${healthData.status}`);
                } else {
                    results.push(`❌ Health check failed: ${healthResponse.status}`);
                }
            } catch (error) {
                results.push(`❌ Health check error: ${error.message}`);
            }
            
            // Test 2: Check if user is authenticated
            const token = localStorage.getItem('authToken');
            if (token) {
                results.push(`✅ Auth token found in localStorage`);
                
                // Test 3: Verify token with server
                try {
                    const verifyResponse = await fetch('/api/account/verify', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (verifyResponse.ok) {
                        const userData = await verifyResponse.json();
                        results.push(`✅ Token verification passed: ${userData.firstName} ${userData.lastName}`);
                    } else {
                        results.push(`❌ Token verification failed: ${verifyResponse.status}`);
                    }
                } catch (error) {
                    results.push(`❌ Token verification error: ${error.message}`);
                }
                
                // Test 4: Test protected endpoint
                try {
                    const statsResponse = await fetch('/api/home/stats', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        results.push(`✅ Protected endpoint access: ${statsData.totalTables} tables`);
                    } else {
                        results.push(`❌ Protected endpoint failed: ${statsResponse.status}`);
                    }
                } catch (error) {
                    results.push(`❌ Protected endpoint error: ${error.message}`);
                }
            } else {
                results.push(`❌ No auth token found - user not authenticated`);
                
                // Test 5: Test protected endpoint without auth
                try {
                    const statsResponse = await fetch('/api/home/stats');
                    if (statsResponse.status === 401) {
                        results.push(`✅ Unauthorized access properly blocked (401)`);
                    } else {
                        results.push(`❌ Unauthorized access not properly handled: ${statsResponse.status}`);
                    }
                } catch (error) {
                    results.push(`❌ Unauthorized test error: ${error.message}`);
                }
            }
            
            // Display results
            resultsDiv.innerHTML = results.map(result => `<p>${result}</p>`).join('');
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '<p>Results cleared</p>';
        }
        
        // Run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            runTests();
        });
    </script>
</body>
</html>
