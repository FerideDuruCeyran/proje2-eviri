<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Uploader - Yeni Tablo Oluştur</title>
    <link rel="stylesheet" href="css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-file-excel"></i> Excel Uploader</h1>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/home" class="nav-link">
                        <i class="fas fa-home"></i> Ana Sayfa
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/upload" class="nav-link active">
                        <i class="fas fa-upload"></i> Excel Yükle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/data" class="nav-link">
                        <i class="fas fa-database"></i> Veri Görüntüle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/tables" class="nav-link">
                        <i class="fas fa-table"></i> Dinamik Tablolar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/connections" class="nav-link">
                        <i class="fas fa-plug"></i> Bağlantılar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/login-logs" class="nav-link">
                        <i class="fas fa-history"></i> Giriş Logları
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/login" class="nav-link">
                        <i class="fas fa-sign-in-alt"></i> Giriş Yap
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/register" class="nav-link">
                        <i class="fas fa-user-plus"></i> Kayıt Ol
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/profile" class="nav-link">
                        <i class="fas fa-user"></i> <span id="userName">Profil</span>
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" data-step="1" onclick="goToStep(1)">
                    <div class="step-number">1</div>
                    <div class="step-title">Giriş</div>
                </div>
                <div class="step" data-step="2" onclick="goToStep(2)">
                    <div class="step-number">2</div>
                    <div class="step-title">Dosya Yükleme</div>
                </div>
                <div class="step" data-step="3" onclick="goToStep(3)">
                    <div class="step-number">3</div>
                    <div class="step-title">Veri Görselleştirme</div>
                </div>
                <div class="step" data-step="4" onclick="goToStep(4)">
                    <div class="step-number">4</div>
                    <div class="step-title">Veri Seçimi</div>
                </div>
                <div class="step" data-step="5" onclick="goToStep(5)">
                    <div class="step-number">5</div>
                    <div class="step-title">Tablo Adı</div>
                </div>
                <div class="step" data-step="6" onclick="goToStep(6)">
                    <div class="step-number">6</div>
                    <div class="step-title">Oluştur</div>
                </div>
            </div>

            <!-- Step 1: Giriş -->
            <div class="step-content active" id="step1">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-play-circle"></i> Yeni Tablo Oluşturma Sihirbazı
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="welcome-section">
                            <div class="welcome-icon">
                                <i class="fas fa-magic fa-4x"></i>
                            </div>
                            <h3>Excel Dosyasından Yeni Tablo Oluştur</h3>
                            <p>Bu sihirbaz size Excel dosyasından SQL Server'da yeni bir tablo oluşturmanızda yardımcı olacak.</p>
                            
                            <div class="feature-list">
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Otomatik veri tipi tespiti</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>SQL Server'a otomatik bağlantı</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Veri önizleme ve düzenleme</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Tablo şeması özelleştirme</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions">
                            <button type="button" class="btn btn-primary btn-large" onclick="nextStep()">
                                Başla <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Dosya Yükleme -->
            <div class="step-content" id="step2">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-upload"></i> Excel Dosyası Yükle
                    </h2>
                </div>
                <div class="card-body">
                        <div class="upload-instructions">
                            <h4><i class="fas fa-info-circle"></i> Yükleme Kuralları</h4>
                            <ul>
                            <li>Sadece Excel dosyaları (.xlsx, .xls) yüklenebilir</li>
                            <li>Maksimum dosya boyutu: 50MB</li>
                            <li>Dosya ilk satırında sütun başlıkları bulunmalıdır</li>
                            <li>Desteklenen veri tipleri: Metin, Sayı, Tarih</li>
                        </ul>
                    </div>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                            <h3>Dosyayı buraya sürükleyin veya tıklayın</h3>
                            <p>Excel dosyasını seçin veya buraya sürükleyin</p>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                            <button type="button" class="btn btn-outline" onclick="document.getElementById('excelFile').click()">
                                <i class="fas fa-folder-open"></i> Dosya Seç
                            </button>
                    </div>

                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-details">
                                <i class="fas fa-file-excel"></i>
                                <div class="file-text">
                                    <div class="file-name" id="fileName"></div>
                                    <div class="file-size" id="fileSize"></div>
                                </div>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" id="nextStep2" onclick="nextStep()" disabled>
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                                </div>
                            </div>
                        </div>
                    </div>

            <!-- Step 3: Veri Görselleştirme -->
            <div class="step-content" id="step3">
                <div class="card">
                        <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-table"></i> Veri Önizleme
                        </h2>
                        </div>
                        <div class="card-body">
                        <div class="data-preview">
                            <div class="preview-header">
                                <h4>Excel Verileri Önizleme</h4>
                                <div class="preview-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-columns"></i> Sütun: <span id="columnCount">0</span>
                                    </span>
                                    <span class="stat-item">
                                        <i class="fas fa-list"></i> Satır: <span id="rowCount">0</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="preview-table" id="previewTable">
                                    <thead id="previewTableHead">
                                        <!-- Headers will be populated here -->
                                </thead>
                                    <tbody id="previewTableBody">
                                        <!-- Data will be populated here -->
                                </tbody>
                            </table>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Veri Seçimi -->
            <div class="step-content" id="step4">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-check-square"></i> Veri Seçimi ve Düzenleme
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="column-selection">
                            <h4>Sütun Seçimi ve Düzenleme</h4>
                            <p>Hangi sütunların tabloya dahil edileceğini seçin ve veri tiplerini düzenleyin.</p>
                            
                            <div class="columns-grid" id="columnsGrid">
                                <!-- Column selection will be populated here -->
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Tablo Adı -->
            <div class="step-content" id="step5">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-tag"></i> Tablo Adı ve Açıklama
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="table-naming">
                            <div class="form-group">
                                <label for="tableName" class="form-label">
                                    <i class="fas fa-table"></i> Tablo Adı
                                </label>
                                <input type="text" id="tableName" class="form-control" 
                                       placeholder="ornek_tablo_adi" required>
                                <small class="form-text">Sadece harf, rakam ve alt çizgi kullanın. Türkçe karakter kullanmayın.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="tableDescription" class="form-label">
                                    <i class="fas fa-comment"></i> Tablo Açıklaması
                                </label>
                                <textarea id="tableDescription" class="form-control" rows="3" 
                                          placeholder="Bu tablo ne için kullanılacak?"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="databaseConnection" class="form-label">
                                    <i class="fas fa-plug"></i> Veritabanı Bağlantısı
                                </label>
                                <select id="databaseConnection" class="form-control">
                                    <option value="">Varsayılan bağlantı kullan</option>
                                </select>
                                <small class="form-text">Özel bir veritabanı bağlantısı seçin veya varsayılan bağlantıyı kullanın.</small>
                            </div>

                            <div class="table-preview">
                                <h5>Tablo Önizlemesi</h5>
                                <div class="preview-schema" id="previewSchema">
                                    <!-- Schema preview will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 6: Oluştur -->
            <div class="step-content" id="step6">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-database"></i> Tablo Oluştur ve Veri Yükle
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="creation-summary">
                            <h4>Oluşturulacak Tablo Özeti</h4>
                            <div class="summary-details" id="summaryDetails">
                                <!-- Summary will be populated here -->
                            </div>
                        </div>

                                                 <div class="two-stage-process">
                             <div class="stage-section" id="stage1Section">
                                 <h5><i class="fas fa-layer-group"></i> Aşama 1: Tablo Yapısı Oluştur</h5>
                                 <p class="text-muted">Excel dosyasından tablo yapısı oluşturulacak ve veritabanında tablo oluşturulacak.</p>
                                 <button type="button" class="btn btn-primary" id="createStructureBtn" onclick="createTableStructure()">
                                     <i class="fas fa-table"></i> Tablo Yapısını Oluştur
                                 </button>
                                 <div class="stage-status" id="stage1Status"></div>
                             </div>

                            <div class="stage-section" id="stage2Section" style="display: none;">
                                <h5><i class="fas fa-database"></i> Aşama 2: Verileri Yükle</h5>
                                <p class="text-muted">Oluşturulan tabloya Excel verileri yüklenecek.</p>
                                <button type="button" class="btn btn-success" id="insertDataBtn" onclick="insertData()">
                                    <i class="fas fa-upload"></i> Verileri Yükle
                                </button>
                                <div class="stage-status" id="stage2Status"></div>
                            </div>
                        </div>

                        <div class="creation-progress" id="creationProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">Hazırlanıyor...</div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-info" id="viewTableBtn" onclick="viewCreatedTable()" style="display: none;">
                                <i class="fas fa-eye"></i> Oluşturulan Tabloyu Görüntüle
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Excel Uploader. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/site.js"></script>
    <script>
        let currentStep = 1;
        let excelData = null;
        let selectedColumns = [];
        let tableName = '';
        let tableDescription = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupFileUpload();
        });

        // File upload setup
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('excelFile');

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // Handle file selection
        function handleFileSelect(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showAlert('Lütfen sadece Excel dosyası seçin (.xlsx, .xls)', 'danger');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showAlert('Dosya boyutu 50MB\'dan büyük olamaz', 'danger');
                return;
            }

            // Display file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('nextStep2').disabled = false;

            // Store file for later use
            excelData = { file: file };
        }

        // Remove file
        function removeFile() {
            document.getElementById('excelFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('nextStep2').disabled = true;
            excelData = null;
        }

        // Navigation functions
        function nextStep() {
            if (currentStep < 6) {
                if (validateCurrentStep()) {
                    currentStep++;
                    updateStepDisplay();
                    if (currentStep === 3) {
                        loadExcelPreview();
                    } else if (currentStep === 4) {
                        setupColumnSelection();
                    } else if (currentStep === 5) {
                        setupTableNaming();
                    } else if (currentStep === 6) {
                        showCreationSummary();
                    }
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        // Update step display
        function updateStepDisplay() {
            // Update progress steps
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index + 1 <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });

            // Update step content
            document.querySelectorAll('.step-content').forEach((content, index) => {
                if (index + 1 === currentStep) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Validate current step
        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return true;
                case 2:
                    return excelData && excelData.file;
                case 3:
                    return true;
                case 4:
                    return selectedColumns.length > 0;
                case 5:
                    return tableName && tableName.trim() !== '';
                default:
                    return true;
            }
        }

        // Load Excel preview
        async function loadExcelPreview() {
            try {
                // Check if user is authenticated
                if (!isAuthenticated) {
                    showAlert('Dosya yüklemek için giriş yapmanız gerekiyor. Lütfen önce giriş yapın.', 'warning');
                    // Redirect to login page
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }

                const formData = new FormData();
                formData.append('file', excelData.file);

                const response = await fetch('/api/home/preview', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (response.ok) {
                    const previewData = await response.json();
                    displayExcelPreview(previewData);
                    
                    // Check if table already exists after Excel file is processed
                    await checkTableExistsAfterUpload();
                } else if (response.status === 401) {
                    showAlert('Oturum süreniz dolmuş. Lütfen tekrar giriş yapın.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Excel dosyası yüklenirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error loading preview:', error);
                showAlert('Excel dosyası yüklenirken hata oluştu', 'danger');
            }
        }

        // Display Excel preview
        function displayExcelPreview(data) {
            const tableHead = document.getElementById('previewTableHead');
            const tableBody = document.getElementById('previewTableBody');
            
            // Clear existing content
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            // Create headers
            const headerRow = document.createElement('tr');
            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // Create data rows (show first 10 rows)
            data.rows.slice(0, 10).forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            // Update stats
            document.getElementById('columnCount').textContent = data.headers.length;
            document.getElementById('rowCount').textContent = data.rows.length;

            // Store data for later use
            excelData.preview = data;
            
            // Show table existence status if available
            if (window.tableExists !== undefined && window.expectedTableName) {
                const previewHeader = document.querySelector('.preview-header h4');
                if (previewHeader && window.tableExists) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'alert alert-info';
                    statusDiv.style.marginTop = '10px';
                    statusDiv.innerHTML = `
                        <i class="fas fa-info-circle"></i>
                        <strong>Tablo Durumu:</strong> "${window.expectedTableName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.
                    `;
                    previewHeader.parentElement.appendChild(statusDiv);
                }
            }
        }

        // Setup column selection
        function setupColumnSelection() {
            const columnsGrid = document.getElementById('columnsGrid');
            columnsGrid.innerHTML = '';

            // Add edit mode toggle
            const editModeDiv = document.createElement('div');
            editModeDiv.className = 'edit-mode-toggle';
            editModeDiv.innerHTML = `
                <div class="alert alert-info">
                    <label class="checkbox-container">
                        <input type="checkbox" id="enableDataTypeEditing" onchange="toggleDataTypeEditing()">
                        <span class="checkmark"></span>
                        <strong>Veri Tipi Düzenlemeyi Etkinleştir</strong>
                    </label>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i> 
                        Veri tipleri otomatik olarak algılanmıştır. Düzenlemek istiyorsanız bu seçeneği etkinleştirin.
                    </small>
                </div>
            `;
            columnsGrid.appendChild(editModeDiv);

            excelData.preview.headers.forEach((header, index) => {
                // Get detected data type from backend
                const detectedType = excelData.preview.dataTypes ? excelData.preview.dataTypes[index] : 'nvarchar(255)';
                
                // Map SQL data type to frontend option value
                let defaultType = 'string';
                if (detectedType.includes('int')) defaultType = 'int';
                else if (detectedType.includes('decimal')) defaultType = 'decimal';
                else if (detectedType.includes('datetime')) defaultType = 'datetime';
                else if (detectedType.includes('bit')) defaultType = 'boolean';
                else if (detectedType.includes('nvarchar(max)')) defaultType = 'longtext';
                else defaultType = 'string';

                const columnDiv = document.createElement('div');
                columnDiv.className = 'column-item';
                columnDiv.innerHTML = `
                    <div class="column-header">
                        <label class="checkbox-container">
                            <input type="checkbox" checked onchange="toggleColumn(${index})">
                            <span class="checkmark"></span>
                            <strong>${header}</strong>
                        </label>
                        <div class="detected-type">
                            <small class="text-success">
                                <i class="fas fa-magic"></i> Otomatik tespit: <strong>${detectedType}</strong>
                            </small>
                        </div>
                    </div>
                    <div class="column-options">
                        <select class="form-control data-type-select" id="dataType_${index}" disabled onchange="updateColumnType(${index}, this.value)">
                            <option value="string" ${defaultType === 'string' ? 'selected' : ''}>Metin (VARCHAR)</option>
                            <option value="int" ${defaultType === 'int' ? 'selected' : ''}>Tam Sayı (INT)</option>
                            <option value="decimal" ${defaultType === 'decimal' ? 'selected' : ''}>Ondalık (DECIMAL)</option>
                            <option value="datetime" ${defaultType === 'datetime' ? 'selected' : ''}>Tarih/Saat (DATETIME)</option>
                            <option value="boolean" ${defaultType === 'boolean' ? 'selected' : ''}>Mantık (BIT)</option>
                            <option value="longtext" ${defaultType === 'longtext' ? 'selected' : ''}>Uzun Metin (MAX)</option>
                        </select>
                    </div>
                `;
                columnsGrid.appendChild(columnDiv);

                // Add to selected columns
                selectedColumns.push({
                    index: index,
                    name: header,
                    type: defaultType,
                    selected: true
                });
            });
        }

        // Toggle column selection
        function toggleColumn(index) {
            selectedColumns[index].selected = !selectedColumns[index].selected;
        }

        // Update column type
        function updateColumnType(index, type) {
            selectedColumns[index].type = type;
        }

        // Toggle data type editing
        function toggleDataTypeEditing() {
            const enableEditing = document.getElementById('enableDataTypeEditing').checked;
            const dataTypeSelects = document.querySelectorAll('.data-type-select');
            
            dataTypeSelects.forEach(select => {
                select.disabled = !enableEditing;
                if (enableEditing) {
                    select.style.backgroundColor = '#ffffff';
                    select.style.borderColor = '#667eea';
                } else {
                    select.style.backgroundColor = '#f8f9fa';
                    select.style.borderColor = '#e1e5e9';
                }
            });
        }

                         // Setup table naming
        function setupTableNaming() {
            // Generate default table name from Excel file name
            const fileName = excelData.file.name.replace(/\.[^/.]+$/, "");
            const defaultName = fileName.replace(/ /g, '_'); // Only replace spaces with underscores
            
            document.getElementById('tableName').value = defaultName;
            document.getElementById('tableName').readOnly = true; // Make it read-only
            
            // Use pre-checked table existence status if available
            if (window.expectedTableName === defaultName && window.tableExists !== undefined) {
                // Table existence was already checked after upload
                if (window.tableExists) {
                    // Show message that table exists and data will be inserted
                    const tableNameElement = document.getElementById('tableName');
                    tableNameElement.style.backgroundColor = '#fff3cd';
                    tableNameElement.style.borderColor = '#ffc107';
                    
                    // Add info message
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'tableExistsInfo';
                    infoDiv.className = 'alert alert-info';
                    infoDiv.innerHTML = `
                        <i class="fas fa-info-circle"></i>
                        <strong>Bilgi:</strong> "${defaultName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.
                    `;
                    
                    const tableNameContainer = tableNameElement.parentElement;
                    if (!document.getElementById('tableExistsInfo')) {
                        tableNameContainer.appendChild(infoDiv);
                    }
                }
            } else {
                // Fallback: Check if table exists now
                checkTableExists(defaultName);
            }
            
            updateSchemaPreview();
            
            // Load database connections
            loadDatabaseConnections();
        }

        // Get authentication token
        function getToken() {
            return localStorage.getItem('authToken');
        }

        // Check if table already exists after Excel file upload
        async function checkTableExistsAfterUpload() {
            try {
                // Generate table name from Excel file name
                const fileName = excelData.file.name.replace(/\.[^/.]+$/, "");
                const tableName = fileName.replace(/ /g, '_'); // Only replace spaces with underscores
                
                const databaseConnectionId = document.getElementById('databaseConnection').value;
                const response = await fetch(`/api/home/check-table-exists?tableName=${encodeURIComponent(tableName)}&databaseConnectionId=${databaseConnectionId || ''}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.tableExists = result.exists;
                    window.expectedTableName = tableName;
                    
                    if (result.exists) {
                        // Show notification that table exists
                        showAlert(`"${tableName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.`, 'info');
                    }
                }
            } catch (error) {
                console.error('Error checking table exists after upload:', error);
            }
        }

        // Check if table already exists
        async function checkTableExists(tableName) {
            try {
                const databaseConnectionId = document.getElementById('databaseConnection').value;
                const response = await fetch(`/api/home/check-table-exists?tableName=${encodeURIComponent(tableName)}&databaseConnectionId=${databaseConnectionId || ''}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.tableExists = result.exists;
                    
                    if (result.exists) {
                        // Show message that table exists and data will be inserted
                        const tableNameElement = document.getElementById('tableName');
                        tableNameElement.style.backgroundColor = '#fff3cd';
                        tableNameElement.style.borderColor = '#ffc107';
                        
                        // Add info message
                        const infoDiv = document.createElement('div');
                        infoDiv.id = 'tableExistsInfo';
                        infoDiv.className = 'alert alert-info';
                        infoDiv.innerHTML = `
                            <i class="fas fa-info-circle"></i>
                            <strong>Bilgi:</strong> "${tableName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.
                        `;
                        
                        const tableNameContainer = tableNameElement.parentElement;
                        if (!document.getElementById('tableExistsInfo')) {
                            tableNameContainer.appendChild(infoDiv);
                        }
                        
                        // Update button text to indicate data will be inserted into existing table
                        const createStructureBtn = document.getElementById('createStructureBtn');
                        if (createStructureBtn) {
                            createStructureBtn.innerHTML = '<i class="fas fa-plus"></i> Verileri Mevcut Tabloya Ekle';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking table exists:', error);
            }
        }

        // Load database connections
        async function loadDatabaseConnections() {
            try {
                const response = await fetch('/api/databaseconnection', {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (response.ok) {
                    const connections = await response.json();
                    const select = document.getElementById('databaseConnection');
                    
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">Varsayılan bağlantı kullan</option>';
                    
                    // Add active connections
                    connections.filter(conn => conn.isActive).forEach(conn => {
                        const option = document.createElement('option');
                        option.value = conn.id;
                        option.textContent = `${conn.name} (${conn.serverName}:${conn.port}/${conn.databaseName})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading database connections:', error);
            }
        }

        // Update schema preview
        function updateSchemaPreview() {
            const previewSchema = document.getElementById('previewSchema');
            const tableName = document.getElementById('tableName').value;
            
            if (!tableName) return;

            let schemaHtml = '';
            
            if (window.tableExists) {
                // Table exists - show INSERT preview
                schemaHtml = `
                    <div class="schema-table">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Mevcut Tablo:</strong> "${tableName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.
                        </div>
                        <h6>INSERT INTO ${tableName} (</h6>
                        <div class="schema-columns">
                `;
            } else {
                // New table - show CREATE preview
                schemaHtml = `
                    <div class="schema-table">
                        <h6>CREATE TABLE ${tableName} (</h6>
                        <div class="schema-columns">
                `;
            }

            selectedColumns.filter(col => col.selected).forEach((col, index) => {
                const sqlType = getSqlType(col.type);
                const comma = index < selectedColumns.filter(c => c.selected).length - 1 ? ',' : '';
                schemaHtml += `
                    <div class="schema-column">
                        &nbsp;&nbsp;${col.name} ${sqlType}${comma}
                    </div>
                `;
            });

            if (window.tableExists) {
                schemaHtml += `
                        </div>
                        ) VALUES (...);
                    </div>
                `;
            } else {
                schemaHtml += `
                        </div>
                        );
                    </div>
                `;
            }

            previewSchema.innerHTML = schemaHtml;
        }

        // Get SQL type
        function getSqlType(type) {
            switch (type) {
                case 'int': return 'INT';
                case 'decimal': return 'DECIMAL(18,2)';
                case 'datetime': return 'DATETIME';
                case 'boolean': return 'BIT';
                default: return 'VARCHAR(255)';
            }
        }

                 // Show creation summary
         function showCreationSummary() {
             const summaryDetails = document.getElementById('summaryDetails');
             const tableName = document.getElementById('tableName').value;
             const tableDescription = document.getElementById('tableDescription').value;
             const stage1Section = document.getElementById('stage1Section');
             const stage2Section = document.getElementById('stage2Section');

             let summaryHtml = `
                 <div class="summary-item">
                     <strong>Tablo Adı:</strong> ${tableName}
                 </div>
                 <div class="summary-item">
                     <strong>Açıklama:</strong> ${tableDescription || 'Açıklama yok'}
                 </div>
                 <div class="summary-item">
                     <strong>Sütun Sayısı:</strong> ${selectedColumns.filter(col => col.selected).length}
                 </div>
                 <div class="summary-item">
                     <strong>Veri Sayısı:</strong> ${excelData.preview.rows.length}
                 </div>
                 <div class="summary-item">
                     <strong>Dosya:</strong> ${excelData.file.name}
                 </div>
             `;
             
             // Add table existence status
             if (window.tableExists) {
                 summaryHtml += `
                     <div class="summary-item" style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                         <i class="fas fa-info-circle"></i>
                         <strong>Durum:</strong> "${tableName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.
                     </div>
                 `;
             } else {
                 summaryHtml += `
                     <div class="summary-item" style="color: #155724; background-color: #d4edda; padding: 10px; border-radius: 5px; margin-top: 10px;">
                         <i class="fas fa-plus-circle"></i>
                         <strong>Durum:</strong> Yeni tablo oluşturulacak ve veriler yüklenecek.
                     </div>
                 `;
             }
             
             summaryDetails.innerHTML = summaryHtml;

             // Check if table exists and adjust UI accordingly
             if (window.tableExists) {
                 // Hide stage 1 (create structure) and show stage 2 (insert data) directly
                 stage1Section.style.display = 'none';
                 stage2Section.style.display = 'block';
                 
                 // Update stage 2 title and description for existing table
                 const stage2Title = stage2Section.querySelector('h5');
                 const stage2Description = stage2Section.querySelector('p');
                 const insertDataBtn = document.getElementById('insertDataBtn');
                 
                 if (stage2Title) stage2Title.innerHTML = '<i class="fas fa-database"></i> Verileri Mevcut Tabloya Ekle';
                 if (stage2Description) stage2Description.textContent = 'Mevcut tabloya Excel verileri eklenecek.';
                 if (insertDataBtn) insertDataBtn.innerHTML = '<i class="fas fa-plus"></i> Verileri Ekle';
             } else {
                 // Show stage 1 for new table creation
                 stage1Section.style.display = 'block';
                 stage2Section.style.display = 'none';
             }
         }

        // Create table
        async function createTableStructure() {
            try {
                const createStructureBtn = document.getElementById('createStructureBtn');
                const stage1Status = document.getElementById('stage1Status');
                const stage2Section = document.getElementById('stage2Section');
                const viewTableBtn = document.getElementById('viewTableBtn');
                const creationProgress = document.getElementById('creationProgress');
                
                createStructureBtn.disabled = true;
                stage1Status.textContent = 'Oluşturuluyor...';
                stage1Status.style.background = '#fff3cd';
                stage1Status.style.color = '#856404';
                stage2Section.style.display = 'none';
                viewTableBtn.style.display = 'none';
                creationProgress.style.display = 'block';

                // Get table name and description
                const tableName = document.getElementById('tableName').value;
                const tableDescription = document.getElementById('tableDescription').value;
                
                if (!tableName || !tableName.trim()) {
                    showAlert('Lütfen tablo adını girin.', 'warning');
                    createStructureBtn.disabled = false;
                    stage1Status.textContent = '✗ Hata!';
                    stage1Status.style.background = '#f8d7da';
                    stage1Status.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                    return;
                }

                // Prepare data
                const formData = new FormData();
                formData.append('ExcelFile', excelData.file);
                formData.append('TableName', tableName);
                formData.append('Description', tableDescription);
                
                // Add database connection ID (force empty to use default connection)
                const databaseConnectionId = document.getElementById('databaseConnection').value;
                formData.append('DatabaseConnectionId', databaseConnectionId || '');

                // Add selected columns data
                const selectedColumnsData = selectedColumns.filter(col => col.selected).map(col => ({
                    name: col.name,
                    type: col.type,
                    index: col.index
                }));
                formData.append('SelectedColumns', JSON.stringify(selectedColumnsData));

                // Update progress
                updateProgress(25, 'Dosya yükleniyor...');

                const response = await fetch('/api/home/insert-data', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                updateProgress(50, 'Tablo yapısı oluşturuluyor...');

                if (response.ok) {
                    updateProgress(75, 'Veriler işleniyor...');
                    const result = await response.json();
                    
                    updateProgress(100, 'Tamamlandı!');
                    
                    // Show SQL output
                    showSqlOutput(result);
                    
                                         setTimeout(() => {
                         const message = result.dataInserted ? 
                             `Veriler mevcut tabloya başarıyla eklendi: ${result.tableName} (${result.rowCount} satır)` : 
                             `Tablo yapısı başarıyla oluşturuldu: ${result.tableName}`;
                         
                         showAlert(message, 'success');
                         stage1Status.textContent = result.dataInserted ? '✓ Veriler Eklendi!' : '✓ Tamamlandı!';
                         stage1Status.style.background = '#d4edda';
                         stage1Status.style.color = '#155724';
                         
                         // Only show stage 2 if data was not already inserted
                         if (!result.dataInserted) {
                             stage2Section.style.display = 'block';
                         } else {
                             // If data was already inserted, hide the create structure button and show completion message
                             createStructureBtn.style.display = 'none';
                             
                             // Add a completion message
                             const completionMessage = document.createElement('div');
                             completionMessage.className = 'alert alert-success mt-3';
                             completionMessage.innerHTML = `
                                 <i class="fas fa-check-circle"></i>
                                 <strong>İşlem Tamamlandı!</strong> Veriler mevcut tabloya başarıyla eklendi. 
                                 <a href="/tables" class="btn btn-sm btn-outline-success ml-2">
                                     <i class="fas fa-table"></i> Tabloları Görüntüle
                                 </a>
                             `;
                             
                             // Insert the completion message after the stage1Status
                             const stage1Status = document.getElementById('stage1Status');
                             stage1Status.parentNode.insertBefore(completionMessage, stage1Status.nextSibling);
                         }
                         
                         viewTableBtn.style.display = 'inline-block';
                         createStructureBtn.disabled = false;
                         window.createdTableId = result.tableId; // Store table ID for stage 2
                         window.tableExists = result.tableExists; // Store table exists status
                         window.dataInserted = result.dataInserted; // Store data inserted status
                         
                         // Update button text if table exists but data wasn't inserted yet
                         if (result.tableExists && !result.dataInserted) {
                             document.getElementById('insertDataBtn').innerHTML = '<i class="fas fa-plus"></i> Verileri Ekle';
                             document.getElementById('createStructureBtn').innerHTML = '<i class="fas fa-plus"></i> Verileri Mevcut Tabloya Ekle';
                         }
                     }, 1000);
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Tablo yapısı oluşturulurken hata oluştu', 'danger');
                    createStructureBtn.disabled = false;
                    stage1Status.textContent = '✗ Hata!';
                    stage1Status.style.background = '#f8d7da';
                    stage1Status.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                }
            } catch (error) {
                console.error('Error creating table structure:', error);
                showAlert('Tablo yapısı oluşturulurken hata oluştu', 'danger');
                createStructureBtn.disabled = false;
                stage1Status.textContent = '✗ Hata!';
                stage1Status.style.background = '#f8d7da';
                stage1Status.style.color = '#721c24';
                creationProgress.style.display = 'none';
            }
        }

        // Show SQL output
        function showSqlOutput(result) {
            const stage1Status = document.getElementById('stage1Status');
            
            // Create SQL output display
            let sqlOutput = `
                <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <h6 style="margin-bottom: 0.5rem; color: #495057;"><i class="fas fa-code"></i> SQL Çıktısı:</h6>
                    <pre style="background: #fff; padding: 1rem; border-radius: 3px; font-size: 0.9rem; overflow-x: auto; margin: 0;">`;
            
            if (result.dataInserted) {
                // Show INSERT statement for existing table
                const tableName = document.getElementById('tableName').value;
                const selectedCols = selectedColumns.filter(col => col.selected);
                const columnNames = selectedCols.map(col => col.name).join(', ');
                
                sqlOutput += `INSERT INTO ${tableName} (${columnNames}) VALUES (...);\n`;
                sqlOutput += `-- ${result.rowCount} satır eklendi`;
            } else if (result.sqlScript) {
                sqlOutput += result.sqlScript;
            } else {
                // Generate SQL script from selected columns
                const tableName = document.getElementById('tableName').value;
                sqlOutput += `CREATE TABLE ${tableName} (\n`;
                
                const selectedCols = selectedColumns.filter(col => col.selected);
                selectedCols.forEach((col, index) => {
                    const sqlType = getSqlType(col.type);
                    const comma = index < selectedCols.length - 1 ? ',' : '';
                    sqlOutput += `    ${col.name} ${sqlType}${comma}\n`;
                });
                
                sqlOutput += `);`;
            }
            
            sqlOutput += `</pre></div>`;
            
            stage1Status.innerHTML = '✓ Tamamlandı!' + sqlOutput;
        }

                 async function insertData() {
             try {
                 const insertDataBtn = document.getElementById('insertDataBtn');
                 const stage2Status = document.getElementById('stage2Status');
                 const creationProgress = document.getElementById('creationProgress');
                 
                 // Check if table ID exists (for new tables) or if we're inserting into existing table
                 if (!window.createdTableId && !window.tableExists) {
                     showAlert('Önce tablo yapısını oluşturmanız gerekiyor. Lütfen 1. adımı tamamlayın.', 'warning');
                     return;
                 }
                
                insertDataBtn.disabled = true;
                stage2Status.textContent = 'Yükleniyor...';
                stage2Status.style.background = '#fff3cd';
                stage2Status.style.color = '#856404';
                creationProgress.style.display = 'block';

                                 // Prepare data
                 const formData = new FormData();
                 formData.append('ExcelFile', excelData.file);
                 
                 // Determine the correct endpoint based on table existence
                 let endpoint;
                 
                 // Artık sadece insert-data endpoint'ini kullanıyoruz
                 endpoint = '/api/home/insert-data';
                 
                 // Add description if available
                 const description = document.getElementById('tableDescription')?.value;
                 if (description && description.trim() !== '') {
                     formData.append('Description', description);
                 }
                 
                 console.log('Using insert-data endpoint for all operations');
                 
                 // Add database connection ID only if it's not empty
                 const databaseConnectionId = document.getElementById('databaseConnection').value;
                 if (databaseConnectionId && databaseConnectionId.trim() !== '') {
                     formData.append('DatabaseConnectionId', databaseConnectionId);
                 }
                 
                 // Debug: Log form data
                 console.log('Form data being sent:');
                 console.log('Endpoint:', endpoint);
                 console.log('TableExists:', window.tableExists);
                 console.log('ExcelFile:', excelData.file);
                 console.log('DatabaseConnectionId:', databaseConnectionId);

                 // Update progress
                 updateProgress(25, 'Dosya yükleniyor...');

                 const response = await fetch(endpoint, {
                     method: 'POST',
                     body: formData,
                     headers: {
                         'Authorization': `Bearer ${getToken()}`
                     }
                 });

                updateProgress(50, 'Veriler işleniyor...');

                if (response.ok) {
                    updateProgress(75, 'Veriler yükleniyor...');
                    const result = await response.json();
                    
                    updateProgress(100, 'Tamamlandı!');
                    
                    // Show data insertion summary
                    showDataInsertionSummary(result);
                    
                                         setTimeout(() => {
                         const message = window.tableExists ? 
                             `Veriler başarıyla eklendi! ${result.insertedRows || 0} satır eklendi.` : 
                             `Veriler başarıyla yüklendi! ${result.insertedRows || 0} satır eklendi.`;
                         
                         showAlert(message, 'success');
                         stage2Status.textContent = '✓ Tamamlandı!';
                         stage2Status.style.background = '#d4edda';
                         stage2Status.style.color = '#155724';
                         insertDataBtn.disabled = false;
                     }, 1000);
                } else {
                    const error = await response.json();
                    let errorMessage = 'Veriler yüklenirken hata oluştu';
                    
                    if (error.error) {
                        errorMessage = error.error;
                    } else if (error.errors) {
                        // Handle validation errors
                        const validationErrors = Object.values(error.errors).flat();
                        errorMessage = validationErrors.join(', ');
                    }
                    
                    showAlert(errorMessage, 'danger');
                    insertDataBtn.disabled = false;
                    stage2Status.textContent = '✗ Hata!';
                    stage2Status.style.background = '#f8d7da';
                    stage2Status.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                }
            } catch (error) {
                console.error('Error inserting data:', error);
                showAlert('Veriler yüklenirken hata oluştu', 'danger');
                insertDataBtn.disabled = false;
                stage2Status.textContent = '✗ Hata!';
                stage2Status.style.background = '#f8d7da';
                stage2Status.style.color = '#721c24';
                creationProgress.style.display = 'none';
            }
        }

        // Show data insertion summary
        function showDataInsertionSummary(result) {
            const stage2Status = document.getElementById('stage2Status');
            
            let summary = `
                <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <h6 style="margin-bottom: 0.5rem; color: #495057;"><i class="fas fa-database"></i> Veri Yükleme Özeti:</h6>
                    <div style="background: #fff; padding: 1rem; border-radius: 3px; font-size: 0.9rem;">
                        <p><strong>Tablo Adı:</strong> ${result.tableName || document.getElementById('tableName').value}</p>
                        <p><strong>Eklenen Satır Sayısı:</strong> ${result.insertedRows || 0}</p>
                        <p><strong>İşlem Durumu:</strong> <span style="color: #28a745;">✓ Başarılı</span></p>
                        <p><strong>İşlem Tarihi:</strong> ${new Date().toLocaleString('tr-TR')}</p>
                    </div>
                </div>`;
            
            stage2Status.innerHTML = '✓ Tamamlandı!' + summary;
        }

        async function viewCreatedTable() {
            try {
                const viewTableBtn = document.getElementById('viewTableBtn');
                const tableName = document.getElementById('tableName').value;
                const databaseConnectionId = document.getElementById('databaseConnection').value;

                if (!tableName) {
                    showAlert('Lütfen tablo adını girin.', 'warning');
                    return;
                }

                // Database connection is optional for viewing tables
                // if (!databaseConnectionId) {
                //     showAlert('Lütfen bir veritabanı bağlantısı seçin.', 'warning');
                //     return;
                // }

                viewTableBtn.disabled = true;
                showAlert(`${tableName} tablosunun verileri görüntüleniyor...`, 'info');

                const url = databaseConnectionId ? 
                    `/api/home/view-table?tableName=${encodeURIComponent(tableName)}&databaseConnectionId=${databaseConnectionId}` :
                    `/api/home/view-table?tableName=${encodeURIComponent(tableName)}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (response.ok) {
                    const tableData = await response.json();
                    showAlert(`${tableName} tablosundan ${tableData.rowCount} satır görüntülendi.`, 'success');
                    // Optionally, display the data in a modal or new tab
                    console.log('Viewed Table Data:', tableData);
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Tablo verileri görüntülenirken hata oluştu', 'danger');
                }
                viewTableBtn.disabled = false;
            } catch (error) {
                console.error('Error viewing table:', error);
                showAlert('Tablo verileri görüntülenirken hata oluştu', 'danger');
            }
        }

        // Update progress
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Step Navigation Functions - Fixed
        const totalSteps = 6;

        function goToStep(stepNumber) {
            // Validate step number
            if (stepNumber < 1 || stepNumber > totalSteps) {
                return;
            }

            // Check if we can go to this step (basic validation)
            if (stepNumber > currentStep) {
                if (!canProceedToStep(stepNumber)) {
                    return;
                }
            }

            // Update current step
            currentStep = stepNumber;

            // Update step indicators
            updateStepIndicators();

            // Show/hide step content
            showStepContent(stepNumber);
            
            // Execute step-specific actions
            executeStepActions(stepNumber);
        }

        function executeStepActions(stepNumber) {
            switch (stepNumber) {
                case 3:
                    if (excelData && excelData.file) {
                        loadExcelPreview();
                    }
                    break;
                case 4:
                    if (excelData && excelData.preview) {
                        setupColumnSelection();
                    }
                    break;
                case 5:
                    if (excelData && excelData.preview) {
                        setupTableNaming();
                    }
                    break;
                case 6:
                    if (excelData && excelData.preview) {
                        showCreationSummary();
                    }
                    break;
            }
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                goToStep(currentStep + 1);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }

        function updateStepIndicators() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                if (stepNumber <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        function showStepContent(stepNumber) {
            // Hide all step content
            const stepContents = document.querySelectorAll('.step-content');
            stepContents.forEach(content => {
                content.classList.remove('active');
            });

            // Show current step content
            const currentContent = document.getElementById(`step${stepNumber}`);
            if (currentContent) {
                currentContent.classList.add('active');
            }
        }

        function canProceedToStep(stepNumber) {
            // Add validation logic for each step
            switch (stepNumber) {
                case 2:
                    // Step 2: File upload - no validation needed
                    return true;
                case 3:
                    // Step 3: Data preview - need file uploaded
                    return excelData && excelData.file;
                case 4:
                    // Step 4: Column selection - need data preview
                    return excelData && excelData.preview;
                case 5:
                    // Step 5: Table naming - need column selection
                    return excelData && excelData.preview && selectedColumns.length > 0;
                case 6:
                    // Step 6: Create table - need all previous steps
                    return excelData && excelData.preview && selectedColumns.length > 0;
                default:
                    return true;
            }
        }

        // Initialize step navigation
        document.addEventListener('DOMContentLoaded', function() {
            currentStep = 1;
            updateStepIndicators();
            showStepContent(1);
        });

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAlert(message, type) {
            // Simple alert implementation
            alert(message);
        }
    </script>
</body>
</html>