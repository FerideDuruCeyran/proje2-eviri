<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Excel Uploader - NUCLEAR CACHE BUST v8.0</title>
    <link rel="stylesheet" href="css/site.css?v=8.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- NUCLEAR CACHE BUSTING v8.0 -->
    <script>
        console.log('=== NUCLEAR V8.0 ÖNBELLEK TEMİZLENDİ ===');
        console.log('Timestamp:', Date.now());
        console.log('Random ID:', Math.random().toString(36).substring(7));
        
        // Clear all possible caches
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
        if ('caches' in window) {
            caches.keys().then(function(names) {
                names.forEach(function(name) {
                    caches.delete(name);
                });
            });
        }
        localStorage.clear();
        sessionStorage.clear();
        
        // Force reload with unique parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.has('v8')) {
            console.log('ZORLA YENİDEN YÜKLEME v8.0...');
            window.location.href = window.location.href + '?v8=' + Date.now();
        }
    </script>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-file-excel"></i> Excel Uploader NUCLEAR v8.0</h1>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/home" class="nav-link">
                        <i class="fas fa-home"></i> Ana Sayfa
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/upload" class="nav-link active">
                        <i class="fas fa-upload"></i> Excel Yükle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/data" class="nav-link">
                        <i class="fas fa-database"></i> Veri Görüntüle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/tables" class="nav-link">
                        <i class="fas fa-table"></i> Dinamik Tablolar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/connections" class="nav-link">
                        <i class="fas fa-plug"></i> Bağlantılar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/login-logs" class="nav-link">
                        <i class="fas fa-history"></i> Giriş Logları
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/profile" class="nav-link">
                        <i class="fas fa-user"></i> Profil
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/logout" class="nav-link">
                        <i class="fas fa-sign-out-alt"></i> Çıkış
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="upload-section">
                <h2><i class="fas fa-file-excel"></i> Excel Dosyası Yükle NUCLEAR v8.0</h2>
                
                <div class="upload-form">
                    <div class="form-group">
                        <label for="excelFile">Excel Dosyası Seç:</label>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="tableName">Tablo Adı:</label>
                        <input type="text" id="tableName" class="form-control" placeholder="Tablo adını girin">
                    </div>
                    
                    <div class="form-group">
                        <label for="tableDescription">Tablo Açıklaması:</label>
                        <textarea id="tableDescription" class="form-control" rows="3" placeholder="Tablo açıklamasını girin"></textarea>
                    </div>
                    
                    <button type="button" class="btn btn-success btn-large" id="processButton" onclick="nuclearUploadFunction()">
                        <i class="fas fa-play"></i> İşlemi Başlat NUCLEAR v8.0
                    </button>
                    
                    <div class="action-status" id="actionStatus"></div>
                </div>
                
                <div class="creation-progress" id="creationProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Hazırlanıyor...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Excel Uploader NUCLEAR v8.0. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // NUCLEAR VERSION 8.0 - COMPLETELY NEW FUNCTION NAME
        console.log('=== NUCLEAR V8.0 YENİ VERSİYON YÜKLENDİ ===');
        console.log('DOĞRU ENDPOINT: /api/home/upload');
        
        async function nuclearUploadFunction() {
            console.log('=== NUCLEAR V8.0 FONKSİYON ÇAĞRILDI ===');
            console.log('DOĞRU ENDPOINT KULLANILIYOR: /api/home/upload');
            
            try {
                const processButton = document.getElementById('processButton');
                const actionStatus = document.getElementById('actionStatus');
                const creationProgress = document.getElementById('creationProgress');
                
                processButton.disabled = true;
                actionStatus.textContent = 'İşleniyor...';
                actionStatus.style.background = '#fff3cd';
                actionStatus.style.color = '#856404';
                creationProgress.style.display = 'block';

                const tableName = document.getElementById('tableName').value;
                const tableDescription = document.getElementById('tableDescription').value;
                const excelFile = document.getElementById('excelFile').files[0];
                
                if (!tableName || !tableName.trim()) {
                    alert('Tablo adı bulunamadı.');
                    processButton.disabled = false;
                    actionStatus.textContent = '✗ Hata!';
                    actionStatus.style.background = '#f8d7da';
                    actionStatus.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                    return;
                }

                if (!excelFile) {
                    alert('Excel dosyası seçilmedi.');
                    processButton.disabled = false;
                    actionStatus.textContent = '✗ Hata!';
                    actionStatus.style.background = '#f8d7da';
                    actionStatus.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                    return;
                }

                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Oturum süreniz dolmuş. Lütfen tekrar giriş yapın.');
                    window.location.href = '/login';
                    return;
                }

                const formData = new FormData();
                formData.append('ExcelFile', excelFile);
                formData.append('TableName', tableName);
                formData.append('Description', tableDescription);

                console.log('DOĞRU ENDPOINT\'E İSTEK GÖNDERİLİYOR: /api/home/upload');
                const uniqueId = Math.random().toString(36).substring(7);
                const response = await fetch(`/api/home/upload?t=${Date.now()}&v=${uniqueId}&cache=bust&version=8.0&nuclear=true`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                console.log('Yanıt alındı:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('BAŞARILI:', result);
                    
                    actionStatus.textContent = '✓ Başarılı!';
                    actionStatus.style.background = '#d4edda';
                    actionStatus.style.color = '#155724';
                    
                    alert('Excel dosyası başarıyla yüklendi!');
                } else {
                    const errorData = await response.json();
                    console.log('HATA:', errorData);
                    
                    actionStatus.textContent = '✗ Hata!';
                    actionStatus.style.background = '#f8d7da';
                    actionStatus.style.color = '#721c24';
                    
                    alert(errorData.error || 'Excel dosyası yüklenirken hata oluştu');
                }
            } catch (error) {
                console.error('Hata:', error);
                
                actionStatus.textContent = '✗ Hata!';
                actionStatus.style.background = '#f8d7da';
                actionStatus.style.color = '#721c24';
                
                alert('Excel dosyası yüklenirken hata oluştu: ' + error.message);
            } finally {
                processButton.disabled = false;
                creationProgress.style.display = 'none';
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== NUCLEAR V8.0 YENİ VERSİYON BAŞLATILDI ===');
        });
    </script>
</body>
</html>
