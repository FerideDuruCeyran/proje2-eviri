<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Uploader - Otomatik Tablo Oluşturma</title>
    <link rel="stylesheet" href="css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-file-excel"></i> Excel Uploader</h1>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/home" class="nav-link">
                        <i class="fas fa-home"></i> Ana Sayfa
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/upload" class="nav-link active">
                        <i class="fas fa-upload"></i> Excel Yükle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/data" class="nav-link">
                        <i class="fas fa-database"></i> Veri Görüntüle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/tables" class="nav-link">
                        <i class="fas fa-table"></i> Dinamik Tablolar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/connections" class="nav-link">
                        <i class="fas fa-plug"></i> Bağlantılar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/login-logs" class="nav-link">
                        <i class="fas fa-history"></i> Giriş Logları
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/login" class="nav-link">
                        <i class="fas fa-sign-in-alt"></i> Giriş Yap
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/register" class="nav-link">
                        <i class="fas fa-user-plus"></i> Kayıt Ol
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/profile" class="nav-link">
                        <i class="fas fa-user"></i> <span id="userName">Profil</span>
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" data-step="1" onclick="goToStep(1)">
                    <div class="step-number">1</div>
                    <div class="step-title">Giriş</div>
                </div>
                <div class="step" data-step="2" onclick="goToStep(2)">
                    <div class="step-number">2</div>
                    <div class="step-title">Dosya Yükleme</div>
                </div>
                <div class="step" data-step="3" onclick="goToStep(3)">
                    <div class="step-number">3</div>
                    <div class="step-title">Veri Önizleme</div>
                </div>
                <div class="step" data-step="4" onclick="goToStep(4)">
                    <div class="step-number">4</div>
                    <div class="step-title">Tablo Adı</div>
                </div>
                <div class="step" data-step="5" onclick="goToStep(5)">
                    <div class="step-number">5</div>
                    <div class="step-title">Özet</div>
                </div>
                <div class="step" data-step="6" onclick="goToStep(6)">
                    <div class="step-number">6</div>
                    <div class="step-title">Oluştur</div>
                </div>
            </div>

            <!-- Step 1: Giriş -->
            <div class="step-content active" id="step1">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-play-circle"></i> Excel Tablo Oluşturma Sihirbazı
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="welcome-section">
                            <div class="welcome-icon">
                                <i class="fas fa-magic fa-4x"></i>
                            </div>
                            <h3>Excel Dosyasından Tablo Oluştur veya Veri Ekle</h3>
                            <p>Bu sihirbaz Excel dosyasından otomatik olarak tablo adı oluşturur. Eğer tablo varsa verileri ekler, yoksa yeni tablo oluşturur.</p>
                            
                            <div class="feature-list">
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Otomatik tablo adı oluşturma</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Mevcut tabloya veri ekleme</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Yeni tablo oluşturma</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Tek tıkla işlem</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions">
                            <button type="button" class="btn btn-primary btn-large" onclick="nextStep()">
                                Başla <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Dosya Yükleme -->
            <div class="step-content" id="step2">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-upload"></i> Excel Dosyası Yükle
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="upload-instructions">
                            <h4><i class="fas fa-info-circle"></i> Yükleme Kuralları</h4>
                            <ul>
                                <li>Sadece Excel dosyaları (.xlsx, .xls) yüklenebilir</li>
                                <li>Maksimum dosya boyutu: 50MB</li>
                                <li>Dosya ilk satırında sütun başlıkları bulunmalıdır</li>
                                <li>Tablo adı dosya adından otomatik oluşturulur</li>
                            </ul>
                        </div>

                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h3>Dosyayı buraya sürükleyin veya tıklayın</h3>
                            <p>Excel dosyasını seçin veya buraya sürükleyin</p>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                            <button type="button" class="btn btn-outline" onclick="document.getElementById('excelFile').click()">
                                <i class="fas fa-folder-open"></i> Dosya Seç
                            </button>
                        </div>

                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-details">
                                <i class="fas fa-file-excel"></i>
                                <div class="file-text">
                                    <div class="file-name" id="fileName"></div>
                                    <div class="file-size" id="fileSize"></div>
                                </div>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" id="nextStep2" onclick="nextStep()" disabled>
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Veri Önizleme -->
            <div class="step-content" id="step3">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-table"></i> Veri Önizleme
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="data-preview">
                            <div class="preview-header">
                                <h4>Excel Verileri Önizleme</h4>
                                <div class="preview-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-columns"></i> Sütun: <span id="columnCount">0</span>
                                    </span>
                                    <span class="stat-item">
                                        <i class="fas fa-list"></i> Satır: <span id="rowCount">0</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="preview-table" id="previewTable">
                                    <thead id="previewTableHead">
                                        <!-- Headers will be populated here -->
                                    </thead>
                                    <tbody id="previewTableBody">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Tablo Adı -->
            <div class="step-content" id="step4">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-tag"></i> Tablo Adı ve Durum
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="table-naming">
                            <div class="form-group">
                                <label for="tableName" class="form-label">
                                    <i class="fas fa-table"></i> Tablo Adı (Otomatik Oluşturuldu)
                                </label>
                                <input type="text" id="tableName" class="form-control" readonly>
                                <small class="form-text">Tablo adı dosya adından otomatik olarak oluşturulmuştur.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="tableDescription" class="form-label">
                                    <i class="fas fa-comment"></i> Tablo Açıklaması (İsteğe Bağlı)
                                </label>
                                <textarea id="tableDescription" class="form-control" rows="3" 
                                          placeholder="Bu tablo ne için kullanılacak?"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="databaseConnection" class="form-label">
                                    <i class="fas fa-plug"></i> Veritabanı Bağlantısı
                                </label>
                                <select id="databaseConnection" class="form-control">
                                    <option value="">Varsayılan bağlantı kullan</option>
                                </select>
                                <small class="form-text">Özel bir veritabanı bağlantısı seçin veya varsayılan bağlantıyı kullanın.</small>
                            </div>

                            <div class="table-status" id="tableStatus">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Durum:</strong> Tablo varlığı kontrol ediliyor...
                                </div>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Özet -->
            <div class="step-content" id="step5">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-clipboard-list"></i> İşlem Özeti
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="summary-details" id="summaryDetails">
                            <!-- Summary will be populated here -->
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 6: Oluştur -->
            <div class="step-content" id="step6">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-database"></i> Tablo İşlemi
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="action-summary" id="actionSummary">
                            <!-- Action summary will be populated here -->
                        </div>

                        <div class="single-action">
                            <button type="button" class="btn btn-success btn-large" id="processButton" onclick="processExcelFile()">
                                <i class="fas fa-play"></i> İşlemi Başlat
                            </button>
                            <div class="action-status" id="actionStatus"></div>
                        </div>

                        <div class="creation-progress" id="creationProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">Hazırlanıyor...</div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-info" id="viewTableBtn" onclick="viewCreatedTable()" style="display: none;">
                                <i class="fas fa-eye"></i> Oluşturulan Tabloyu Görüntüle
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Excel Uploader. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/site.js"></script>
    <script>
        // Quick authentication check before page loads
        (function() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
        })();

        let currentStep = 1;
        let excelData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            if (!isAuthenticated) {
                window.location.href = '/login';
                return;
            }
            setupFileUpload();
        });

        // File upload setup
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('excelFile');

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // Handle file selection
        function handleFileSelect(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showAlert('Lütfen sadece Excel dosyası seçin (.xlsx, .xls)', 'danger');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showAlert('Dosya boyutu 50MB\'dan büyük olamaz', 'danger');
                return;
            }

            // Display file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('nextStep2').disabled = false;

            // Store file for later use
            excelData = { file: file };
        }

        // Remove file
        function removeFile() {
            document.getElementById('excelFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('nextStep2').disabled = true;
            excelData = null;
        }

        // Navigation functions
        function nextStep() {
            if (currentStep < 6) {
                if (validateCurrentStep()) {
                    currentStep++;
                    updateStepDisplay();
                    if (currentStep === 3) {
                        loadExcelPreview();
                    } else if (currentStep === 4) {
                        setupTableNaming();
                    } else if (currentStep === 5) {
                        showCreationSummary();
                    } else if (currentStep === 6) {
                        setupActionSummary();
                    }
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        // Update step display
        function updateStepDisplay() {
            // Update progress steps
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index + 1 <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });

            // Update step content
            document.querySelectorAll('.step-content').forEach((content, index) => {
                if (index + 1 === currentStep) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Validate current step
        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return true;
                case 2:
                    return excelData && excelData.file;
                case 3:
                    return true;
                case 4:
                    return true; // Table name is automatically generated
                case 5:
                    return true; // Summary is always shown
                default:
                    return true;
            }
        }

        // Load Excel preview
        async function loadExcelPreview() {
            try {
                if (!isAuthenticated) {
                    showAlert('Dosya yüklemek için giriş yapmanız gerekiyor. Lütfen önce giriş yapın.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }

                if (!excelData.file) {
                    showAlert('Lütfen önce bir Excel dosyası seçin', 'warning');
                    return;
                }

                const formData = new FormData();
                formData.append('file', excelData.file);

                const response = await fetch('/api/home/preview', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (response.ok) {
                    const previewData = await response.json();
                    console.log('Preview data received:', previewData);
                    displayExcelPreview(previewData);
                    await checkTableExistsAfterUpload();
                } else if (response.status === 401) {
                    showAlert('Oturum süreniz dolmuş. Lütfen tekrar giriş yapın.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Excel dosyası yüklenirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error loading preview:', error);
                showAlert('Excel dosyası yüklenirken hata oluştu', 'danger');
            }
        }

        // Display Excel preview
        function displayExcelPreview(data) {
            const tableHead = document.getElementById('previewTableHead');
            const tableBody = document.getElementById('previewTableBody');
            
            // Clear existing content
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            // Check if data exists
            if (!data || !data.headers) {
                console.error('Invalid preview data:', data);
                showAlert('Önizleme verisi alınamadı', 'danger');
                return;
            }

            // Create headers
            const headerRow = document.createElement('tr');
            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // Create data rows (show preview data)
            if (data.previewData && Array.isArray(data.previewData)) {
                data.previewData.forEach(row => {
                    const tr = document.createElement('tr');
                    if (Array.isArray(row)) {
                        row.forEach(cell => {
                            const td = document.createElement('td');
                            td.textContent = cell || '';
                            tr.appendChild(td);
                        });
                    }
                    tableBody.appendChild(tr);
                });
            } else if (data.rows && Array.isArray(data.rows)) {
                // Fallback for old format
                data.rows.slice(0, 10).forEach(row => {
                    const tr = document.createElement('tr');
                    if (Array.isArray(row)) {
                        row.forEach(cell => {
                            const td = document.createElement('td');
                            td.textContent = cell || '';
                            tr.appendChild(td);
                        });
                    }
                    tableBody.appendChild(tr);
                });
            }

            // Update stats
            document.getElementById('columnCount').textContent = data.totalColumns || data.headers.length;
            document.getElementById('rowCount').textContent = data.totalRows || (data.rows ? data.rows.length : 0);

            // Store data for later use
            excelData.preview = data;
        }

        // Setup table naming
        function setupTableNaming() {
            // Generate default table name from Excel file name
            const fileName = excelData.file.name.replace(/\.[^/.]+$/, "");
            const defaultName = fileName.replace(/ /g, '_'); // Only replace spaces with underscores
            
            document.getElementById('tableName').value = defaultName;
            
            // Check if table exists
            checkTableExists(defaultName);
            
            // Load database connections
            loadDatabaseConnections();
        }

        // Get authentication token
        function getToken() {
            return localStorage.getItem('authToken');
        }

        // Check if table already exists after Excel file upload
        async function checkTableExistsAfterUpload() {
            try {
                const fileName = excelData.file.name.replace(/\.[^/.]+$/, "");
                const tableName = fileName.replace(/ /g, '_');
                
                const databaseConnectionId = document.getElementById('databaseConnection').value;
                const response = await fetch(`/api/home/check-table-exists?tableName=${encodeURIComponent(tableName)}&databaseConnectionId=${databaseConnectionId || ''}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.tableExists = result.exists === true;
                    window.expectedTableName = tableName;
                    
                    if (result.exists === true) {
                        showAlert(`"${tableName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.`, 'info');
                    }
                }
            } catch (error) {
                console.error('Error checking table exists after upload:', error);
            }
        }

        // Check if table already exists
        async function checkTableExists(tableName) {
            try {
                const databaseConnectionId = document.getElementById('databaseConnection').value;
                const response = await fetch(`/api/home/check-table-exists?tableName=${encodeURIComponent(tableName)}&databaseConnectionId=${databaseConnectionId || ''}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.tableExists = result.exists === true;
                    
                    const tableStatus = document.getElementById('tableStatus');
                    if (result.exists === true) {
                        tableStatus.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Durum:</strong> "${tableName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.
                            </div>
                        `;
                    } else {
                        tableStatus.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-plus-circle"></i>
                                <strong>Durum:</strong> "${tableName}" tablosu mevcut değil. Yeni tablo oluşturulacak.
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error checking table exists:', error);
                const tableStatus = document.getElementById('tableStatus');
                tableStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Hata:</strong> Tablo durumu kontrol edilemedi.
                    </div>
                `;
            }
        }

        // Load database connections
        async function loadDatabaseConnections() {
            try {
                const response = await fetch('/api/databaseconnection', {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (response.ok) {
                    const connections = await response.json();
                    const select = document.getElementById('databaseConnection');
                    
                    select.innerHTML = '<option value="">Varsayılan bağlantı kullan</option>';
                    
                    connections.filter(conn => conn.isActive).forEach(conn => {
                        const option = document.createElement('option');
                        option.value = conn.id;
                        option.textContent = `${conn.name} (${conn.serverName}:${conn.port}/${conn.databaseName})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading database connections:', error);
            }
        }

        // Show creation summary
        function showCreationSummary() {
            const summaryDetails = document.getElementById('summaryDetails');
            const tableName = document.getElementById('tableName').value;
            const tableDescription = document.getElementById('tableDescription').value;

            let summaryHtml = `
                <div class="summary-item">
                    <strong>Tablo Adı:</strong> ${tableName}
                </div>
                <div class="summary-item">
                    <strong>Açıklama:</strong> ${tableDescription || 'Açıklama yok'}
                </div>
                <div class="summary-item">
                    <strong>Sütun Sayısı:</strong> ${excelData.preview.totalColumns || excelData.preview.headers.length}
                </div>
                <div class="summary-item">
                    <strong>Veri Sayısı:</strong> ${excelData.preview.totalRows || 0}
                </div>
                <div class="summary-item">
                    <strong>Dosya:</strong> ${excelData.file.name}
                </div>
            `;
            
            if (window.tableExists === true) {
                summaryHtml += `
                    <div class="summary-item" style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i>
                        <strong>Durum:</strong> "${tableName}" tablosu zaten mevcut. Veriler mevcut tabloya eklenecek.
                    </div>
                `;
            } else {
                summaryHtml += `
                    <div class="summary-item" style="color: #155724; background-color: #d4edda; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <i class="fas fa-plus-circle"></i>
                        <strong>Durum:</strong> Yeni tablo oluşturulacak ve veriler yüklenecek.
                    </div>
                `;
            }
            
            summaryDetails.innerHTML = summaryHtml;
        }

        // Setup action summary
        function setupActionSummary() {
            const actionSummary = document.getElementById('actionSummary');
            const tableName = document.getElementById('tableName').value;
            
            if (window.tableExists === true) {
                actionSummary.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>İşlem:</strong> "${tableName}" tablosuna veri eklenecek.
                    </div>
                `;
            } else {
                actionSummary.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-plus-circle"></i>
                        <strong>İşlem:</strong> "${tableName}" adında yeni tablo oluşturulacak ve veriler eklenecek.
                    </div>
                `;
            }
        }

        // Process Excel file (main function)
        async function processExcelFile() {
            try {
                const processButton = document.getElementById('processButton');
                const actionStatus = document.getElementById('actionStatus');
                const creationProgress = document.getElementById('creationProgress');
                const viewTableBtn = document.getElementById('viewTableBtn');
                
                processButton.disabled = true;
                actionStatus.textContent = 'İşleniyor...';
                actionStatus.style.background = '#fff3cd';
                actionStatus.style.color = '#856404';
                viewTableBtn.style.display = 'none';
                creationProgress.style.display = 'block';

                const tableName = document.getElementById('tableName').value;
                const tableDescription = document.getElementById('tableDescription').value;
                
                if (!tableName || !tableName.trim()) {
                    showAlert('Tablo adı bulunamadı.', 'warning');
                    processButton.disabled = false;
                    actionStatus.textContent = '✗ Hata!';
                    actionStatus.style.background = '#f8d7da';
                    actionStatus.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                    return;
                }

                if (!excelData || !excelData.file) {
                    showAlert('Lütfen bir Excel dosyası seçin.', 'warning');
                    processButton.disabled = false;
                    actionStatus.textContent = '✗ Hata!';
                    actionStatus.style.background = '#f8d7da';
                    actionStatus.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                    return;
                }

                const token = getToken();
                if (!token) {
                    showAlert('Oturum açmanız gerekiyor. Lütfen giriş yapın.', 'warning');
                    processButton.disabled = false;
                    actionStatus.textContent = '✗ Hata!';
                    actionStatus.style.background = '#f8d7da';
                    actionStatus.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                    return;
                }

                // Prepare form data with correct field names
                const formData = new FormData();
                formData.append('ExcelFile', excelData.file);
                formData.append('Description', tableDescription || '');
                
                const databaseConnectionId = document.getElementById('databaseConnection').value;
                if (databaseConnectionId && databaseConnectionId.trim() !== '') {
                    formData.append('DatabaseConnectionId', databaseConnectionId);
                }

                // Debug: Log form data contents
                console.log('Form data being sent:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}:`, value);
                }

                updateProgress(25, 'Dosya yükleniyor...');

                console.log('Making request to /api/home/upload');
                const response = await fetch('/api/home/upload', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Response received:', response.status, response.statusText);
                console.log('Response headers:', response.headers);

                updateProgress(50, 'Veriler işleniyor...');

                if (response.ok) {
                    updateProgress(75, 'Tablo işlemi tamamlanıyor...');
                    const result = await response.json();
                    console.log('Success response:', result);
                    
                    updateProgress(100, 'Tamamlandı!');
                    
                    setTimeout(() => {
                        let message;
                        if (result.action === 'data_inserted_into_existing') {
                            message = `Veriler mevcut tabloya başarıyla eklendi: ${result.tableName} (${result.rowCount} satır)`;
                        } else {
                            message = `Yeni tablo oluşturuldu ve veriler eklendi: ${result.tableName} (${result.rowCount} satır)`;
                        }
                        
                        showAlert(message, 'success');
                        actionStatus.textContent = '✓ Tamamlandı!';
                        actionStatus.style.background = '#d4edda';
                        actionStatus.style.color = '#155724';
                        
                        viewTableBtn.style.display = 'inline-block';
                        processButton.disabled = false;
                        window.createdTableId = result.tableId;
                        
                        const actionSummary = document.getElementById('actionSummary');
                        actionSummary.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>İşlem Tamamlandı!</strong> ${message}
                            </div>
                        `;
                    }, 1000);
                } else {
                    console.log('Error response status:', response.status);
                    let errorData;
                    try {
                        errorData = await response.json();
                        console.error('API Error Response:', errorData);
                    } catch (parseError) {
                        console.error('Failed to parse error response:', parseError);
                        errorData = { error: 'Unknown error occurred' };
                    }
                    
                    let errorMessage = 'Tablo işlemi sırasında hata oluştu';
                    if (errorData.error) {
                        errorMessage = errorData.error;
                    } else if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.details) {
                        errorMessage = `Hata: ${errorData.details}`;
                    } else if (errorData.errors && Array.isArray(errorData.errors)) {
                        errorMessage = `Validation Errors: ${errorData.errors.map(e => e.Errors?.join(', ') || e).join('; ')}`;
                    }
                    
                    console.error('Final error message:', errorMessage);
                    showAlert(errorMessage, 'danger');
                    processButton.disabled = false;
                    actionStatus.textContent = '✗ Hata!';
                    actionStatus.style.background = '#f8d7da';
                    actionStatus.style.color = '#721c24';
                    creationProgress.style.display = 'none';
                }
            } catch (error) {
                console.error('Error processing Excel file:', error);
                console.error('Error stack:', error.stack);
                showAlert('Excel dosyası işlenirken hata oluştu', 'danger');
                processButton.disabled = false;
                actionStatus.textContent = '✗ Hata!';
                actionStatus.style.background = '#f8d7da';
                actionStatus.style.color = '#721c24';
                creationProgress.style.display = 'none';
            }
        }

        async function viewCreatedTable() {
            try {
                const viewTableBtn = document.getElementById('viewTableBtn');
                const tableName = document.getElementById('tableName').value;
                const databaseConnectionId = document.getElementById('databaseConnection').value;

                if (!tableName) {
                    showAlert('Lütfen tablo adını girin.', 'warning');
                    return;
                }

                viewTableBtn.disabled = true;
                showAlert(`${tableName} tablosunun verileri görüntüleniyor...`, 'info');

                const url = databaseConnectionId ? 
                    `/api/home/view-table?tableName=${encodeURIComponent(tableName)}&databaseConnectionId=${databaseConnectionId}` :
                    `/api/home/view-table?tableName=${encodeURIComponent(tableName)}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (response.ok) {
                    const tableData = await response.json();
                    showAlert(`${tableName} tablosundan ${tableData.rowCount} satır görüntülendi.`, 'success');
                    console.log('Viewed Table Data:', tableData);
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Tablo verileri görüntülenirken hata oluştu', 'danger');
                }
                viewTableBtn.disabled = false;
            } catch (error) {
                console.error('Error viewing table:', error);
                showAlert('Tablo verileri görüntülenirken hata oluştu', 'danger');
            }
        }

        // Update progress
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Step Navigation Functions
        const totalSteps = 6;

        function goToStep(stepNumber) {
            if (stepNumber < 1 || stepNumber > totalSteps) {
                return;
            }

            if (stepNumber > currentStep) {
                if (!canProceedToStep(stepNumber)) {
                    return;
                }
            }

            currentStep = stepNumber;
            updateStepIndicators();
            showStepContent(stepNumber);
            executeStepActions(stepNumber);
        }

        function executeStepActions(stepNumber) {
            switch (stepNumber) {
                case 3:
                    if (excelData && excelData.file) {
                        loadExcelPreview();
                    }
                    break;
                case 4:
                    if (excelData && excelData.preview) {
                        setupTableNaming();
                    }
                    break;
                case 5:
                    if (excelData && excelData.preview) {
                        showCreationSummary();
                    }
                    break;
                case 6:
                    if (excelData && excelData.preview) {
                        setupActionSummary();
                    }
                    break;
            }
        }

        function updateStepIndicators() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                if (stepNumber <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        function showStepContent(stepNumber) {
            const stepContents = document.querySelectorAll('.step-content');
            stepContents.forEach(content => {
                content.classList.remove('active');
            });

            const currentContent = document.getElementById(`step${stepNumber}`);
            if (currentContent) {
                currentContent.classList.add('active');
            }
        }

        function canProceedToStep(stepNumber) {
            switch (stepNumber) {
                case 2:
                    return true;
                case 3:
                    return excelData && excelData.file;
                case 4:
                    return excelData && excelData.preview;
                case 5:
                    return excelData && excelData.preview;
                case 6:
                    return excelData && excelData.preview;
                default:
                    return true;
            }
        }

        // Initialize step navigation
        document.addEventListener('DOMContentLoaded', function() {
            currentStep = 1;
            updateStepIndicators();
            showStepContent(1);
        });

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAlert(message, type) {
            alert(message);
        }
    </script>
</body>
</html>