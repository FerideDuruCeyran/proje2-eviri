<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Uploader - Yeni Tablo Oluştur</title>
    <link rel="stylesheet" href="css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-file-excel"></i> Excel Uploader</h1>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/" class="nav-link">
                        <i class="fas fa-home"></i> Ana Sayfa
                    </a>
                </li>
                <li class="nav-item auth-only" style="display: none;">
                    <a href="/upload" class="nav-link active">
                        <i class="fas fa-upload"></i> Dosya Yükle
                    </a>
                </li>
                <li class="nav-item auth-only" style="display: none;">
                    <a href="/data" class="nav-link">
                        <i class="fas fa-database"></i> Veri Görüntüle
                    </a>
                </li>
                <li class="nav-item auth-only" style="display: none;">
                    <a href="/tables" class="nav-link">
                        <i class="fas fa-table"></i> Dinamik Tablolar
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/login" class="nav-link">
                        <i class="fas fa-sign-in-alt"></i> Giriş Yap
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/register" class="nav-link">
                        <i class="fas fa-user-plus"></i> Kayıt Ol
                    </a>
                </li>
                <li class="nav-item auth-only" style="display: none;">
                    <a href="/profile" class="nav-link">
                        <i class="fas fa-user"></i> <span id="userName">Profil</span>
                    </a>
                </li>
                <li class="nav-item auth-only" style="display: none;">
                    <a href="/logout" class="nav-link">
                        <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Giriş</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Dosya Yükleme</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Veri Görselleştirme</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">Veri Seçimi</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-title">Tablo Adı</div>
                </div>
                <div class="step" data-step="6">
                    <div class="step-number">6</div>
                    <div class="step-title">Oluştur</div>
                </div>
            </div>

            <!-- Step 1: Giriş -->
            <div class="step-content active" id="step1">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-play-circle"></i> Yeni Tablo Oluşturma Sihirbazı
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="welcome-section">
                            <div class="welcome-icon">
                                <i class="fas fa-magic fa-4x"></i>
                            </div>
                            <h3>Excel Dosyasından Yeni Tablo Oluştur</h3>
                            <p>Bu sihirbaz size Excel dosyasından SQL Server'da yeni bir tablo oluşturmanızda yardımcı olacak.</p>
                            
                            <div class="feature-list">
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Otomatik veri tipi tespiti</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>SQL Server'a otomatik bağlantı</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Veri önizleme ve düzenleme</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Tablo şeması özelleştirme</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions">
                            <button type="button" class="btn btn-primary btn-large" onclick="nextStep()">
                                Başla <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Dosya Yükleme -->
            <div class="step-content" id="step2">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-upload"></i> Excel Dosyası Yükle
                    </h2>
                </div>
                <div class="card-body">
                        <div class="upload-instructions">
                            <h4><i class="fas fa-info-circle"></i> Yükleme Kuralları</h4>
                            <ul>
                            <li>Sadece Excel dosyaları (.xlsx, .xls) yüklenebilir</li>
                            <li>Maksimum dosya boyutu: 50MB</li>
                            <li>Dosya ilk satırında sütun başlıkları bulunmalıdır</li>
                            <li>Desteklenen veri tipleri: Metin, Sayı, Tarih</li>
                        </ul>
                    </div>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                            <h3>Dosyayı buraya sürükleyin veya tıklayın</h3>
                            <p>Excel dosyasını seçin veya buraya sürükleyin</p>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                            <button type="button" class="btn btn-outline" onclick="document.getElementById('excelFile').click()">
                                <i class="fas fa-folder-open"></i> Dosya Seç
                            </button>
                    </div>

                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-details">
                                <i class="fas fa-file-excel"></i>
                                <div class="file-text">
                                    <div class="file-name" id="fileName"></div>
                                    <div class="file-size" id="fileSize"></div>
                                </div>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" id="nextStep2" onclick="nextStep()" disabled>
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                                </div>
                            </div>
                        </div>
                    </div>

            <!-- Step 3: Veri Görselleştirme -->
            <div class="step-content" id="step3">
                <div class="card">
                        <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-table"></i> Veri Önizleme
                        </h2>
                        </div>
                        <div class="card-body">
                        <div class="data-preview">
                            <div class="preview-header">
                                <h4>Excel Verileri Önizleme</h4>
                                <div class="preview-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-columns"></i> Sütun: <span id="columnCount">0</span>
                                    </span>
                                    <span class="stat-item">
                                        <i class="fas fa-list"></i> Satır: <span id="rowCount">0</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="preview-table" id="previewTable">
                                    <thead id="previewTableHead">
                                        <!-- Headers will be populated here -->
                                </thead>
                                    <tbody id="previewTableBody">
                                        <!-- Data will be populated here -->
                                </tbody>
                            </table>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Veri Seçimi -->
            <div class="step-content" id="step4">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-check-square"></i> Veri Seçimi ve Düzenleme
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="column-selection">
                            <h4>Sütun Seçimi ve Düzenleme</h4>
                            <p>Hangi sütunların tabloya dahil edileceğini seçin ve veri tiplerini düzenleyin.</p>
                            
                            <div class="columns-grid" id="columnsGrid">
                                <!-- Column selection will be populated here -->
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Tablo Adı -->
            <div class="step-content" id="step5">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-tag"></i> Tablo Adı ve Açıklama
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="table-naming">
                            <div class="form-group">
                                <label for="tableName" class="form-label">
                                    <i class="fas fa-table"></i> Tablo Adı
                                </label>
                                <input type="text" id="tableName" class="form-control" 
                                       placeholder="ornek_tablo_adi" required>
                                <small class="form-text">Sadece harf, rakam ve alt çizgi kullanın. Türkçe karakter kullanmayın.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="tableDescription" class="form-label">
                                    <i class="fas fa-comment"></i> Tablo Açıklaması
                                </label>
                                <textarea id="tableDescription" class="form-control" rows="3" 
                                          placeholder="Bu tablo ne için kullanılacak?"></textarea>
                            </div>

                            <div class="table-preview">
                                <h5>Tablo Önizlemesi</h5>
                                <div class="preview-schema" id="previewSchema">
                                    <!-- Schema preview will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Devam Et <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 6: Oluştur -->
            <div class="step-content" id="step6">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-database"></i> Tablo Oluştur
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="creation-summary">
                            <h4>Oluşturulacak Tablo Özeti</h4>
                            <div class="summary-details" id="summaryDetails">
                                <!-- Summary will be populated here -->
                            </div>
                        </div>

                        <div class="creation-progress" id="creationProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">Hazırlanıyor...</div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                            <button type="button" class="btn btn-success btn-large" id="createTableBtn" onclick="createTable()">
                                <i class="fas fa-magic"></i> Tabloyu Oluştur
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Excel Uploader. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/site.js"></script>
    <script>
        let currentStep = 1;
        let excelData = null;
        let selectedColumns = [];
        let tableName = '';
        let tableDescription = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupFileUpload();
        });

        // File upload setup
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('excelFile');

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // Handle file selection
        function handleFileSelect(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showAlert('Lütfen sadece Excel dosyası seçin (.xlsx, .xls)', 'danger');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showAlert('Dosya boyutu 50MB\'dan büyük olamaz', 'danger');
                return;
            }

            // Display file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('nextStep2').disabled = false;

            // Store file for later use
            excelData = { file: file };
        }

        // Remove file
        function removeFile() {
            document.getElementById('excelFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('nextStep2').disabled = true;
            excelData = null;
        }

        // Navigation functions
        function nextStep() {
            if (currentStep < 6) {
                if (validateCurrentStep()) {
                    currentStep++;
                    updateStepDisplay();
                    if (currentStep === 3) {
                        loadExcelPreview();
                    } else if (currentStep === 4) {
                        setupColumnSelection();
                    } else if (currentStep === 5) {
                        setupTableNaming();
                    } else if (currentStep === 6) {
                        showCreationSummary();
                    }
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        // Update step display
        function updateStepDisplay() {
            // Update progress steps
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index + 1 <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });

            // Update step content
            document.querySelectorAll('.step-content').forEach((content, index) => {
                if (index + 1 === currentStep) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Validate current step
        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return true;
                case 2:
                    return excelData && excelData.file;
                case 3:
                    return true;
                case 4:
                    return selectedColumns.length > 0;
                case 5:
                    return tableName && tableName.trim() !== '';
                default:
                    return true;
            }
        }

        // Load Excel preview
        async function loadExcelPreview() {
            try {
                const formData = new FormData();
                formData.append('file', excelData.file);

                const response = await fetch('/api/home/preview', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const previewData = await response.json();
                    displayExcelPreview(previewData);
                } else {
                    showAlert('Excel dosyası yüklenirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error loading preview:', error);
                showAlert('Excel dosyası yüklenirken hata oluştu', 'danger');
            }
        }

        // Display Excel preview
        function displayExcelPreview(data) {
            const tableHead = document.getElementById('previewTableHead');
            const tableBody = document.getElementById('previewTableBody');
            
            // Clear existing content
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            // Create headers
            const headerRow = document.createElement('tr');
            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // Create data rows (show first 10 rows)
            data.rows.slice(0, 10).forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            // Update stats
            document.getElementById('columnCount').textContent = data.headers.length;
            document.getElementById('rowCount').textContent = data.rows.length;

            // Store data for later use
            excelData.preview = data;
        }

        // Setup column selection
        function setupColumnSelection() {
            const columnsGrid = document.getElementById('columnsGrid');
            columnsGrid.innerHTML = '';

            excelData.preview.headers.forEach((header, index) => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'column-item';
                columnDiv.innerHTML = `
                    <div class="column-header">
                        <label class="checkbox-container">
                            <input type="checkbox" checked onchange="toggleColumn(${index})">
                            <span class="checkmark"></span>
                            <strong>${header}</strong>
                        </label>
                    </div>
                    <div class="column-options">
                        <select class="form-control" onchange="updateColumnType(${index}, this.value)">
                            <option value="string">Metin (VARCHAR)</option>
                            <option value="int">Tam Sayı (INT)</option>
                            <option value="decimal">Ondalık (DECIMAL)</option>
                            <option value="datetime">Tarih/Saat (DATETIME)</option>
                            <option value="boolean">Mantık (BIT)</option>
                        </select>
                    </div>
                `;
                columnsGrid.appendChild(columnDiv);

                // Add to selected columns
                selectedColumns.push({
                    index: index,
                    name: header,
                    type: 'string',
                    selected: true
                });
            });
        }

        // Toggle column selection
        function toggleColumn(index) {
            selectedColumns[index].selected = !selectedColumns[index].selected;
        }

        // Update column type
        function updateColumnType(index, type) {
            selectedColumns[index].type = type;
        }

        // Setup table naming
        function setupTableNaming() {
            // Generate default table name
            const fileName = excelData.file.name.replace(/\.[^/.]+$/, "");
            const defaultName = fileName.toLowerCase()
                .replace(/[^a-z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
            
            document.getElementById('tableName').value = defaultName;
            updateSchemaPreview();
        }

        // Update schema preview
        function updateSchemaPreview() {
            const previewSchema = document.getElementById('previewSchema');
            const tableName = document.getElementById('tableName').value;
            
            if (!tableName) return;

            let schemaHtml = `
                <div class="schema-table">
                    <h6>CREATE TABLE ${tableName} (</h6>
                    <div class="schema-columns">
            `;

            selectedColumns.filter(col => col.selected).forEach((col, index) => {
                const sqlType = getSqlType(col.type);
                const comma = index < selectedColumns.filter(c => c.selected).length - 1 ? ',' : '';
                schemaHtml += `
                    <div class="schema-column">
                        &nbsp;&nbsp;${col.name} ${sqlType}${comma}
                    </div>
                `;
            });

            schemaHtml += `
                    </div>
                    );
                </div>
            `;

            previewSchema.innerHTML = schemaHtml;
        }

        // Get SQL type
        function getSqlType(type) {
            switch (type) {
                case 'int': return 'INT';
                case 'decimal': return 'DECIMAL(18,2)';
                case 'datetime': return 'DATETIME';
                case 'boolean': return 'BIT';
                default: return 'VARCHAR(255)';
            }
        }

        // Show creation summary
        function showCreationSummary() {
            const summaryDetails = document.getElementById('summaryDetails');
            const tableName = document.getElementById('tableName').value;
            const tableDescription = document.getElementById('tableDescription').value;

            summaryDetails.innerHTML = `
                <div class="summary-item">
                    <strong>Tablo Adı:</strong> ${tableName}
                </div>
                <div class="summary-item">
                    <strong>Açıklama:</strong> ${tableDescription || 'Açıklama yok'}
                </div>
                <div class="summary-item">
                    <strong>Sütun Sayısı:</strong> ${selectedColumns.filter(col => col.selected).length}
                </div>
                <div class="summary-item">
                    <strong>Veri Sayısı:</strong> ${excelData.preview.rows.length}
                </div>
                <div class="summary-item">
                    <strong>Dosya:</strong> ${excelData.file.name}
                </div>
            `;
        }

        // Create table
        async function createTable() {
            try {
                const createTableBtn = document.getElementById('createTableBtn');
                const creationProgress = document.getElementById('creationProgress');
                
                createTableBtn.disabled = true;
                creationProgress.style.display = 'block';

                // Prepare data
                const formData = new FormData();
                formData.append('file', excelData.file);
                formData.append('tableName', document.getElementById('tableName').value);
                formData.append('description', document.getElementById('tableDescription').value);
                formData.append('columns', JSON.stringify(selectedColumns.filter(col => col.selected)));

                // Update progress
                updateProgress(25, 'Dosya yükleniyor...');

                const response = await fetch('/api/home/upload', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                updateProgress(50, 'Veriler işleniyor...');

                if (response.ok) {
                    updateProgress(75, 'Tablo oluşturuluyor...');
                    const result = await response.json();
                    
                    updateProgress(100, 'Tamamlandı!');
                    
                    setTimeout(() => {
                        showAlert(`Tablo başarıyla oluşturuldu: ${result.tableName}`, 'success');
                        // Redirect to tables page
                        window.location.href = '/tables';
                    }, 1000);
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Tablo oluşturulurken hata oluştu', 'danger');
                    createTableBtn.disabled = false;
                    creationProgress.style.display = 'none';
                }
            } catch (error) {
                console.error('Error creating table:', error);
                showAlert('Tablo oluşturulurken hata oluştu', 'danger');
                createTableBtn.disabled = false;
                creationProgress.style.display = 'none';
            }
        }

        // Update progress
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAlert(message, type) {
            // Simple alert implementation
            alert(message);
        }
    </script>
</body>
</html>
