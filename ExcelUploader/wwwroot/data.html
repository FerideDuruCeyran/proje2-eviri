<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Uploader - Veri Görüntüle</title>
    <link rel="stylesheet" href="css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-file-excel"></i> Excel Uploader</h1>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/home" class="nav-link">
                        <i class="fas fa-home"></i> Ana Sayfa
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/upload" class="nav-link">
                        <i class="fas fa-upload"></i> Excel Yükle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/data" class="nav-link active">
                        <i class="fas fa-database"></i> Veri Görüntüle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/tables" class="nav-link">
                        <i class="fas fa-table"></i> Dinamik Tablolar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/connections" class="nav-link">
                        <i class="fas fa-plug"></i> Bağlantılar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/login-logs" class="nav-link">
                        <i class="fas fa-history"></i> Giriş Logları
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/login" class="nav-link">
                        <i class="fas fa-sign-in-alt"></i> Giriş Yap
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/register" class="nav-link">
                        <i class="fas fa-user-plus"></i> Kayıt Ol
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/profile" class="nav-link">
                        <i class="fas fa-user"></i> <span id="userName">Profil</span>
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-database"></i> Veri Görüntüle</h1>
                <p>Yüklenen Excel dosyalarındaki verileri görüntüleyin ve analiz edin</p>
            </div>

            <!-- Data Overview Cards -->
            <div class="overview-cards">
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="overview-content">
                        <h3 id="totalTables">0</h3>
                        <p>Toplam Tablo</p>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="overview-content">
                        <h3 id="totalRecords">0</h3>
                        <p>Toplam Kayıt</p>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="overview-content">
                        <h3 id="totalFiles">0</h3>
                        <p>Toplam Dosya</p>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="overview-content">
                        <h3 id="lastUpdate">-</h3>
                        <p>Son Güncelleme</p>
                    </div>
                </div>
            </div>

            <!-- Table Selection -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-filter"></i> Tablo Seçimi
                    </h2>
                </div>
                <div class="card-body">
                    <div class="table-selection">
                        <div class="form-group">
                            <label for="tableSelect" class="form-label">Görüntülenecek Tablo</label>
                            <select id="tableSelect" class="form-control" onchange="loadTableData()">
                                <option value="">Tüm Tablolar</option>
                            </select>
                        </div>
                        <div class="table-actions">
                            <button type="button" class="btn btn-primary" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Yenile
                            </button>
                            <button type="button" class="btn btn-success" onclick="exportData()">
                                <i class="fas fa-download"></i> Dışa Aktar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-table"></i> Veri Tablosu
                    </h2>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="searchInput" class="form-control" placeholder="Ara..." onkeyup="filterTable()">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="table-info">
                            <span id="tableInfo">0 kayıt gösteriliyor</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table" id="dataTable">
                            <thead id="tableHead">
                                <tr>
                                    <th>Yükleniyor...</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="100" class="loading-cell">
                                        <div class="spinner"></div>
                                        <p>Veriler yükleniyor...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination" id="pagination" style="display: none;">
                        <button type="button" class="btn btn-outline" onclick="previousPage()">
                            <i class="fas fa-chevron-left"></i> Önceki
                        </button>
                        <span class="page-info" id="pageInfo">Sayfa 1 / 1</span>
                        <button type="button" class="btn btn-outline" onclick="nextPage()">
                            Sonraki <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Analytics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-bar"></i> Veri Analizi
                    </h2>
                </div>
                <div class="card-body">
                    <div class="analytics-grid">
                        <div class="analytics-item">
                            <h4>Veri Dağılımı</h4>
                            <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                                <canvas id="dataDistributionChart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-item">
                            <h4>Zaman Serisi</h4>
                            <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                                <canvas id="timeSeriesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Excel Uploader. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- site.js removed - using inline JavaScript -->
    <script>
        // Quick authentication check before page loads
        (function() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
        })();

        let currentTableData = [];
        let currentPage = 1;
        let itemsPerPage = 15; // Changed to 15 as requested
        let filteredData = [];
        let totalPages = 1;
        let totalItems = 0;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            if (!isAuthenticated) {
                window.location.href = '/login';
                return;
            }
            loadOverviewData();
            loadTablesList();
            loadAllData(); // Load all data by default
            
            // Check if we have a tableId parameter from URL
            const urlParams = new URLSearchParams(window.location.search);
            const tableId = urlParams.get('tableId');
            console.log('URL params:', window.location.search);
            console.log('TableId from URL:', tableId);
            
            if (tableId) {
                console.log('TableId found, will select table after loading');
                // Wait a bit for tables to load, then select the specific table
                setTimeout(() => {
                    console.log('Setting table select value to:', tableId);
                    document.getElementById('tableSelect').value = tableId;
                    console.log('Table select value is now:', document.getElementById('tableSelect').value);
                    loadTableData();
                }, 1000);
            } else {
                console.log('No tableId parameter found');
            }
        });

        // Load overview data
        async function loadOverviewData() {
            try {
                const response = await fetch('/api/home/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalTables').textContent = stats.totalTables || 0;
                    document.getElementById('totalRecords').textContent = stats.totalRecords || 0;
                    document.getElementById('totalFiles').textContent = stats.totalFiles || 0;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('tr-TR');
                }
            } catch (error) {
                console.error('Error loading overview data:', error);
            }
        }

        // Load tables list
        async function loadTablesList() {
            try {
                const response = await fetch('/api/home/data', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Full response:', result);
                    
                    // Always expect the new format with data and pagination
                    if (result && result.data) {
                        console.log('Tables data:', result.data);
                        console.log('Tables data type:', typeof result.data);
                        console.log('Is array:', Array.isArray(result.data));
                        
                        // Force convert to array if needed
                        let tablesArray = [];
                        if (Array.isArray(result.data)) {
                            tablesArray = result.data;
                        } else if (result.data && typeof result.data === 'object') {
                            // If it's an object, try to convert to array
                            tablesArray = Object.values(result.data);
                        } else {
                            console.error('Cannot convert to array:', result.data);
                            tablesArray = [];
                        }
                        
                        console.log('Final tablesArray:', tablesArray);
                        console.log('Final tablesArray type:', typeof tablesArray);
                        console.log('Final tablesArray isArray:', Array.isArray(tablesArray));
                        populateTableSelect(tablesArray);
                    } else {
                        console.error('No data property in response:', result);
                        populateTableSelect([]);
                    }
                } else {
                    console.error('Response not ok:', response.status);
                    populateTableSelect([]);
                }
            } catch (error) {
                console.error('Error loading tables:', error);
                populateTableSelect([]);
            }
        }

        // Populate table select
        function populateTableSelect(tables) {
            console.log('populateTableSelect called with:', tables);
            console.log('populateTableSelect type:', typeof tables);
            console.log('populateTableSelect isArray:', Array.isArray(tables));
            
            const select = document.getElementById('tableSelect');
            if (!select) {
                console.error('tableSelect element not found');
                return;
            }
            
            select.innerHTML = '<option value="">Tüm Tablolar</option>';
            
            // Ensure tables is an array
            if (!Array.isArray(tables)) {
                console.error('populateTableSelect: tables is not an array:', tables);
                return;
            }
            
            // Additional safety check
            if (tables.length === 0) {
                console.log('No tables to populate');
                return;
            }
            
            try {
                tables.forEach((table, index) => {
                    console.log(`Processing table ${index}:`, table);
                    if (table && table.id && table.tableName) {
                        const option = document.createElement('option');
                        option.value = table.id;
                        option.textContent = `${table.tableName} (${table.rowCount || 0} kayıt)`;
                        select.appendChild(option);
                    } else {
                        console.warn('Invalid table object:', table);
                    }
                });
            } catch (error) {
                console.error('Error in forEach:', error);
            }
        }

        // Load table data
        async function loadTableData() {
            const tableId = document.getElementById('tableSelect').value;
            
            if (!tableId) {
                // Load all data
                await loadAllData();
            } else {
                // Load specific table data
                await loadSpecificTableData(tableId);
            }
        }

        // Load all data with pagination
        async function loadAllData(page = 1) {
            try {
                showLoading();
                const response = await fetch(`/api/home/data/all?page=${page}&pageSize=${itemsPerPage}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('loadAllData response:', result);
                    
                    // Ensure data is an array
                    if (result.data && Array.isArray(result.data)) {
                        currentTableData = result.data;
                    } else {
                        console.error('Invalid data format:', result.data);
                        currentTableData = [];
                    }
                    
                    filteredData = [...currentTableData];
                    
                    // Update pagination info
                    currentPage = result.pagination.currentPage;
                    totalPages = result.pagination.totalPages;
                    totalItems = result.pagination.totalItems;
                    
                    console.log('currentTableData:', currentTableData);
                    displayTableData();
                    updatePagination();
                } else {
                    const errorData = await response.json();
                    showError(errorData.message || 'Veriler yüklenirken hata oluştu');
                }
            } catch (error) {
                console.error('Error loading all data:', error);
                showError('Veriler yüklenirken hata oluştu');
            }
        }

        // Load specific table data
        async function loadSpecificTableData(tableId) {
            try {
                showLoading();
                const response = await fetch(`/api/home/data?tableId=${tableId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentTableData = result.data || result;
                    filteredData = [...currentTableData];
                    displayTableData();
                } else {
                    const errorData = await response.json();
                    showError(errorData.message || 'Tablo verileri yüklenirken hata oluştu');
                }
            } catch (error) {
                console.error('Error loading table data:', error);
                showError('Tablo verileri yüklenirken hata oluştu');
            }
        }

        // Display table data
        function displayTableData() {
            // Use global currentTableData
            filteredData = [...currentTableData];
            
            if (currentTableData.length === 0) {
                showNoData();
                return;
            }

            // Create table headers
            createTableHeaders();
            
            // Display first page
            currentPage = 1;
            displayCurrentPage();
            
            // Update pagination
            updatePagination();
            
            // Update table info
            updateTableInfo();
            
            // Update data analysis charts
            updateDataAnalysis();
        }

        // Create table headers
        function createTableHeaders() {
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '';
            
            if (currentTableData.length === 0) return;
            
            const firstItem = currentTableData[0];
            const headers = Object.keys(firstItem);
            
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = formatHeader(header);
                th.onclick = () => sortTable(header);
                th.className = 'sortable';
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
        }

        // Format header
        function formatHeader(header) {
            return header
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        // Display current page
        function displayCurrentPage() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            pageData.forEach(item => {
                const row = document.createElement('tr');
                Object.values(item).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = formatCellValue(value);
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
        }

        // Format cell value
        function formatCellValue(value) {
            if (value === null || value === undefined) return '-';
            if (value instanceof Date) return value.toLocaleDateString('tr-TR');
            if (typeof value === 'boolean') return value ? 'Evet' : 'Hayır';
            if (typeof value === 'object') {
                // For objects, try to extract meaningful information
                if (Array.isArray(value)) {
                    return `[${value.length} öğe]`;
                }
                if (value.constructor === Object) {
                    const keys = Object.keys(value);
                    if (keys.length === 0) return '{}';
                    if (keys.length <= 3) {
                        return keys.map(key => `${key}: ${value[key]}`).join(', ');
                    }
                    return `{${keys.slice(0, 2).join(', ')}...}`;
                }
                // Handle other object types
                try {
                    return JSON.stringify(value);
                } catch (e) {
                    return '[Object]';
                }
            }
            return String(value);
        }

        // Update pagination
        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            pageInfo.textContent = `Sayfa ${currentPage} / ${totalPages} (Toplam ${totalItems} kayıt)`;
            
            // Update button states
            const prevBtn = paginationDiv.querySelector('button:first-child');
            const nextBtn = paginationDiv.querySelector('button:last-child');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        // Update table info
        function updateTableInfo() {
            const totalRecords = filteredData.length;
            const startRecord = (currentPage - 1) * itemsPerPage + 1;
            const endRecord = Math.min(currentPage * itemsPerPage, totalRecords);
            
            document.getElementById('tableInfo').textContent = 
                `${startRecord}-${endRecord} / ${totalRecords} kayıt gösteriliyor`;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                loadAllData(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                loadAllData(currentPage + 1);
            }
        }

        // Search and filter
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                filteredData = [...currentTableData];
            } else {
                filteredData = currentTableData.filter(item => {
                    return Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            currentPage = 1;
            displayCurrentPage();
            updatePagination();
            updateTableInfo();
        }

        // Sort table
        function sortTable(column) {
            const isAscending = !filteredData[0] || 
                filteredData[0].sortDirection !== column || 
                filteredData[0].sortDirection === 'desc';
            
            filteredData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';
                
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                
                if (aVal < bVal) return isAscending ? -1 : 1;
                if (aVal > bVal) return isAscending ? 1 : -1;
                return 0;
            });
            
            // Update sort direction
            filteredData.forEach(item => item.sortDirection = isAscending ? 'asc' : 'desc');
            
            currentPage = 1;
            displayCurrentPage();
            updatePagination();
            updateTableInfo();
        }

        // Utility functions
        function showLoading() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" class="loading-cell">
                        <div class="spinner"></div>
                        <p>Veriler yükleniyor...</p>
                    </td>
                </tr>
            `;
        }

        function showNoData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" class="no-data-cell">
                        <i class="fas fa-inbox fa-3x"></i>
                        <p>Görüntülenecek veri bulunamadı</p>
                    </td>
                </tr>
            `;
            document.getElementById('pagination').style.display = 'none';
        }

        function showError(message) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" class="error-cell">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <p>${message}</p>
                    </td>
                </tr>
            `;
        }

        function refreshData() {
            loadTableData();
        }

        // Data Analysis Functions
        let dataDistributionChart = null;
        let timeSeriesChart = null;

        function updateDataAnalysis() {
            if (currentTableData.length === 0) {
                clearCharts();
                return;
            }

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.log('Chart.js not loaded');
                return;
            }

            console.log('Creating charts with', currentTableData.length, 'rows');
            createDataDistributionChart();
            createTimeSeriesChart();
        }

        function createDataDistributionChart() {
            const ctx = document.getElementById('dataDistributionChart');
            if (!ctx) {
                console.log('dataDistributionChart canvas not found');
                return;
            }

            console.log('Creating data distribution chart');

            // Destroy existing chart
            if (dataDistributionChart) {
                dataDistributionChart.destroy();
            }

            // Analyze data distribution
            const distribution = analyzeDataDistribution();
            console.log('Distribution:', distribution);
            
            dataDistributionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: distribution.labels,
                    datasets: [{
                        data: distribution.data,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe',
                            '#00f2fe',
                            '#43e97b',
                            '#38f9d7'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        title: {
                            display: true,
                            text: 'Veri Dağılımı',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        function createTimeSeriesChart() {
            const ctx = document.getElementById('timeSeriesChart');
            if (!ctx) return;

            // Destroy existing chart
            if (timeSeriesChart) {
                timeSeriesChart.destroy();
            }

            // Analyze time series data
            const timeData = analyzeTimeSeries();
            
            timeSeriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeData.labels,
                    datasets: [{
                        label: 'Veri Miktarı',
                        data: timeData.data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Zaman Serisi Analizi',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function analyzeDataDistribution() {
            const distribution = {};
            
            currentTableData.forEach(row => {
                Object.keys(row).forEach(key => {
                    if (key.startsWith('_')) return; // Skip metadata columns
                    
                    const value = row[key];
                    const type = typeof value;
                    
                    if (!distribution[type]) {
                        distribution[type] = 0;
                    }
                    distribution[type]++;
                });
            });

            return {
                labels: Object.keys(distribution).map(type => {
                    switch(type) {
                        case 'string': return 'Metin';
                        case 'number': return 'Sayı';
                        case 'boolean': return 'Boolean';
                        case 'object': return 'Nesne';
                        default: return type;
                    }
                }),
                data: Object.values(distribution)
            };
        }

        function analyzeTimeSeries() {
            // Group data by upload date or creation date
            const dateGroups = {};
            
            currentTableData.forEach(row => {
                let dateKey = 'Bilinmeyen';
                
                if (row._UploadDate) {
                    const date = new Date(row._UploadDate);
                    dateKey = date.toLocaleDateString('tr-TR');
                } else if (row._TableName) {
                    // Use table name as time series if no date available
                    dateKey = row._TableName;
                }
                
                if (!dateGroups[dateKey]) {
                    dateGroups[dateKey] = 0;
                }
                dateGroups[dateKey]++;
            });

            const labels = Object.keys(dateGroups).slice(0, 10); // Limit to 10 items
            const data = labels.map(label => dateGroups[label]);

            return { labels, data };
        }

        function clearCharts() {
            if (dataDistributionChart) {
                dataDistributionChart.destroy();
                dataDistributionChart = null;
            }
            if (timeSeriesChart) {
                timeSeriesChart.destroy();
                timeSeriesChart = null;
            }
        }

        function exportData() {
            if (filteredData.length === 0) {
                alert('Dışa aktarılacak veri bulunamadı');
                return;
            }
            
            // Simple CSV export
            const headers = Object.keys(filteredData[0]);
            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',') 
                            ? `"${value}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'veri_export.csv';
            link.click();
        }
    </script>
    
    <!-- Initialize app -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
</body>
</html>
