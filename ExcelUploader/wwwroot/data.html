<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Uploader - Veri Görüntüle</title>
    <link rel="stylesheet" href="css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-file-excel"></i> Excel Uploader</h1>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/home" class="nav-link">
                        <i class="fas fa-home"></i> Ana Sayfa
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/upload" class="nav-link">
                        <i class="fas fa-upload"></i> Excel Yükle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/data" class="nav-link active">
                        <i class="fas fa-database"></i> Veri Görüntüle
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/tables" class="nav-link">
                        <i class="fas fa-table"></i> Dinamik Tablolar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/connections" class="nav-link">
                        <i class="fas fa-plug"></i> Bağlantılar
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/login-logs" class="nav-link">
                        <i class="fas fa-history"></i> Giriş Logları
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/login" class="nav-link">
                        <i class="fas fa-sign-in-alt"></i> Giriş Yap
                    </a>
                </li>
                <li class="nav-item unauth-only">
                    <a href="/register" class="nav-link">
                        <i class="fas fa-user-plus"></i> Kayıt Ol
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="/profile" class="nav-link">
                        <i class="fas fa-user"></i> <span id="userName">Profil</span>
                    </a>
                </li>
                <li class="nav-item auth-only">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-database"></i> Veri Görüntüle</h1>
                <p>Yüklenen Excel dosyalarındaki verileri görüntüleyin ve analiz edin</p>
            </div>

            <!-- Data Overview Cards -->
            <div class="overview-cards">
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="overview-content">
                        <h3 id="totalTables">0</h3>
                        <p>Toplam Tablo</p>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="overview-content">
                        <h3 id="totalRecords">0</h3>
                        <p>Toplam Kayıt</p>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="overview-content">
                        <h3 id="totalFiles">0</h3>
                        <p>Toplam Dosya</p>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="overview-content">
                        <h3 id="lastUpdate">-</h3>
                        <p>Son Güncelleme</p>
                    </div>
                </div>
            </div>

            <!-- Table Selection -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-filter"></i> Tablo Seçimi
                    </h2>
                </div>
                <div class="card-body">
                    <div class="table-selection">
                        <div class="form-group">
                            <label for="tableSelect" class="form-label">Görüntülenecek Tablo</label>
                            <select id="tableSelect" class="form-control" onchange="loadTableData()">
                                <option value="">Tüm Tablolar</option>
                            </select>
                        </div>
                        <div class="table-actions">
                            <button type="button" class="btn btn-primary" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Yenile
                            </button>
                            <button type="button" class="btn btn-success" onclick="exportData()">
                                <i class="fas fa-download"></i> Dışa Aktar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-table"></i> Veri Tablosu
                    </h2>
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="searchInput" class="form-control" placeholder="Ara..." onkeyup="filterTable()">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="table-info">
                            <span id="tableInfo">0 kayıt gösteriliyor</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table" id="dataTable">
                            <thead id="tableHead">
                                <tr>
                                    <th>Yükleniyor...</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="100" class="loading-cell">
                                        <div class="spinner"></div>
                                        <p>Veriler yükleniyor...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination" id="pagination" style="display: none;">
                        <button type="button" class="btn btn-outline" onclick="previousPage()">
                            <i class="fas fa-chevron-left"></i> Önceki
                        </button>
                        <span class="page-info" id="pageInfo">Sayfa 1 / 1</span>
                        <button type="button" class="btn btn-outline" onclick="nextPage()">
                            Sonraki <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Analytics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-bar"></i> Veri Analizi
                    </h2>
                </div>
                <div class="card-body">
                    <div class="analytics-grid">
                        <div class="analytics-item">
                            <h4>Veri Dağılımı</h4>
                            <div class="chart-placeholder" id="dataDistributionChart">
                                <i class="fas fa-chart-pie fa-3x"></i>
                                <p>Veri dağılım grafiği burada görünecek</p>
                            </div>
                        </div>
                        <div class="analytics-item">
                            <h4>Zaman Serisi</h4>
                            <div class="chart-placeholder" id="timeSeriesChart">
                                <i class="fas fa-chart-line fa-3x"></i>
                                <p>Zaman serisi grafiği burada görünecek</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Excel Uploader. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/site.js"></script>
    <script>
        // Quick authentication check before page loads
        (function() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
        })();

        let currentTableData = [];
        let currentPage = 1;
        let itemsPerPage = 50;
        let filteredData = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            if (!isAuthenticated) {
                window.location.href = '/login';
                return;
            }
            loadOverviewData();
            loadTablesList();
            
            // Check if we have a tableId parameter from URL
            const urlParams = new URLSearchParams(window.location.search);
            const tableId = urlParams.get('tableId');
            console.log('URL params:', window.location.search);
            console.log('TableId from URL:', tableId);
            
            if (tableId) {
                console.log('TableId found, will select table after loading');
                // Wait a bit for tables to load, then select the specific table
                setTimeout(() => {
                    console.log('Setting table select value to:', tableId);
                    document.getElementById('tableSelect').value = tableId;
                    console.log('Table select value is now:', document.getElementById('tableSelect').value);
                    loadTableData();
                }, 1000);
            } else {
                console.log('No tableId parameter found');
            }
        });

        // Load overview data
        async function loadOverviewData() {
            try {
                const response = await fetch('/api/home/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalTables').textContent = stats.totalTables || 0;
                    document.getElementById('totalRecords').textContent = stats.totalRecords || 0;
                    document.getElementById('totalFiles').textContent = stats.totalFiles || 0;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('tr-TR');
                }
            } catch (error) {
                console.error('Error loading overview data:', error);
            }
        }

        // Load tables list
        async function loadTablesList() {
            try {
                console.log('Loading tables list...');
                const response = await fetch('/api/home/data', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                console.log('Tables response status:', response.status);
                
                if (response.ok) {
                    const tables = await response.json();
                    console.log('Tables loaded:', tables);
                    populateTableSelect(tables);
                } else {
                    console.error('Failed to load tables:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error loading tables:', error);
            }
        }

        // Populate table select
        function populateTableSelect(tables) {
            console.log('Populating table select with:', tables);
            const select = document.getElementById('tableSelect');
            select.innerHTML = '<option value="">Tüm Tablolar</option>';
            
            tables.forEach(table => {
                console.log('Adding table option:', table);
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = `${table.tableName} (${table.rowCount} kayıt)`;
                select.appendChild(option);
            });
            
            console.log('Table select populated with', tables.length, 'options');
        }

        // Load table data
        async function loadTableData() {
            const tableId = document.getElementById('tableSelect').value;
            
            if (!tableId) {
                // Load all data
                await loadAllData();
            } else {
                // Load specific table data
                await loadSpecificTableData(tableId);
            }
        }

        // Load all data
        async function loadAllData() {
            try {
                showLoading();
                const response = await fetch('/api/home/data', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayTableData(data);
                }
            } catch (error) {
                console.error('Error loading all data:', error);
                showError('Veriler yüklenirken hata oluştu');
            }
        }

        // Load specific table data
        async function loadSpecificTableData(tableId) {
            try {
                showLoading();
                const response = await fetch(`/api/home/data?tableId=${tableId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayTableData(data);
                }
            } catch (error) {
                console.error('Error loading table data:', error);
                showError('Tablo verileri yüklenirken hata oluştu');
            }
        }

        // Display table data
        function displayTableData(data) {
            currentTableData = Array.isArray(data) ? data : [data];
            filteredData = [...currentTableData];
            
            if (currentTableData.length === 0) {
                showNoData();
                return;
            }

            // Create table headers
            createTableHeaders();
            
            // Display first page
            currentPage = 1;
            displayCurrentPage();
            
            // Update pagination
            updatePagination();
            
            // Update table info
            updateTableInfo();
        }

        // Create table headers
        function createTableHeaders() {
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '';
            
            if (currentTableData.length === 0) return;
            
            const firstItem = currentTableData[0];
            const headers = Object.keys(firstItem);
            
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = formatHeader(header);
                th.onclick = () => sortTable(header);
                th.className = 'sortable';
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
        }

        // Format header
        function formatHeader(header) {
            return header
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        // Display current page
        function displayCurrentPage() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            pageData.forEach(item => {
                const row = document.createElement('tr');
                Object.values(item).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = formatCellValue(value);
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
        }

        // Format cell value
        function formatCellValue(value) {
            if (value === null || value === undefined) return '-';
            if (value instanceof Date) return value.toLocaleDateString('tr-TR');
            if (typeof value === 'boolean') return value ? 'Evet' : 'Hayır';
            return value.toString();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent = `Sayfa ${currentPage} / ${totalPages}`;
        }

        // Update table info
        function updateTableInfo() {
            const totalRecords = filteredData.length;
            const startRecord = (currentPage - 1) * itemsPerPage + 1;
            const endRecord = Math.min(currentPage * itemsPerPage, totalRecords);
            
            document.getElementById('tableInfo').textContent = 
                `${startRecord}-${endRecord} / ${totalRecords} kayıt gösteriliyor`;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
                updatePagination();
                updateTableInfo();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayCurrentPage();
                updatePagination();
                updateTableInfo();
            }
        }

        // Search and filter
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                filteredData = [...currentTableData];
            } else {
                filteredData = currentTableData.filter(item => {
                    return Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            currentPage = 1;
            displayCurrentPage();
            updatePagination();
            updateTableInfo();
        }

        // Sort table
        function sortTable(column) {
            const isAscending = !filteredData[0] || 
                filteredData[0].sortDirection !== column || 
                filteredData[0].sortDirection === 'desc';
            
            filteredData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';
                
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                
                if (aVal < bVal) return isAscending ? -1 : 1;
                if (aVal > bVal) return isAscending ? 1 : -1;
                return 0;
            });
            
            // Update sort direction
            filteredData.forEach(item => item.sortDirection = isAscending ? 'asc' : 'desc');
            
            currentPage = 1;
            displayCurrentPage();
            updatePagination();
            updateTableInfo();
        }

        // Utility functions
        function showLoading() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" class="loading-cell">
                        <div class="spinner"></div>
                        <p>Veriler yükleniyor...</p>
                    </td>
                </tr>
            `;
        }

        function showNoData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" class="no-data-cell">
                        <i class="fas fa-inbox fa-3x"></i>
                        <p>Görüntülenecek veri bulunamadı</p>
                    </td>
                </tr>
            `;
            document.getElementById('pagination').style.display = 'none';
        }

        function showError(message) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" class="error-cell">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <p>${message}</p>
                    </td>
                </tr>
            `;
        }

        function refreshData() {
            loadTableData();
        }

        function exportData() {
            if (filteredData.length === 0) {
                alert('Dışa aktarılacak veri bulunamadı');
                return;
            }
            
            // Simple CSV export
            const headers = Object.keys(filteredData[0]);
            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',') 
                            ? `"${value}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'veri_export.csv';
            link.click();
        }
    </script>
</body>
</html>
