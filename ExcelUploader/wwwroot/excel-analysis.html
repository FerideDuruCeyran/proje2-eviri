<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Analizi - Excel Uploader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin: 0.25rem 0;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.75rem;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.75rem 0.75rem 0 0 !important;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .data-type-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .confidence-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        .column-analysis {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }
        .sample-data-table {
            font-size: 0.875rem;
        }
        .sample-data-table th {
            background: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        #analysisResults {
            display: none;
        }
        .sheet-selector {
            background: white;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .sheet-selector:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a href="/" class="nav-link">
                                <i class="fas fa-home"></i> Ana Sayfa
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/upload" class="nav-link">
                                <i class="fas fa-upload"></i> Dosya Yükle
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/data" class="nav-link">
                                <i class="fas fa-database"></i> Veriler
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/tables" class="nav-link">
                                <i class="fas fa-table"></i> Tablolar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/connections" class="nav-link">
                                <i class="fas fa-plug"></i> Bağlantılar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/excel-analysis" class="nav-link active">
                                <i class="fas fa-chart-bar"></i> Excel Analizi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/login-logs" class="nav-link">
                                <i class="fas fa-history"></i> Giriş Geçmişi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/profile" class="nav-link">
                                <i class="fas fa-user"></i> Profil
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/logout" class="nav-link">
                                <i class="fas fa-sign-out-alt"></i> Çıkış
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-chart-bar text-primary"></i> Excel Analizi
                    </h1>
                </div>

                <!-- File Upload Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-upload"></i> Excel Dosyası Seçin</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="excelFile" class="form-label">Excel Dosyası</label>
                                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sheetSelect" class="form-label">Sayfa Seçin</label>
                                    <select class="form-select sheet-selector" id="sheetSelect" disabled>
                                        <option value="">Önce dosya seçin</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="databaseConnection" class="form-label">Veritabanı Bağlantısı</label>
                                    <select class="form-select" id="databaseConnection">
                                        <option value="">Varsayılan Bağlantı</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="description" class="form-label">Açıklama</label>
                                    <input type="text" class="form-control" id="description" placeholder="Tablo açıklaması">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary me-2" onclick="analyzeExcel()">
                                    <i class="fas fa-search"></i> Analiz Et
                                </button>
                                <button type="button" class="btn btn-success me-2" onclick="createTableStructure()">
                                    <i class="fas fa-table"></i> Tablo Yapısı Oluştur
                                </button>
                                <button type="button" class="btn btn-warning me-2" onclick="createTableWithData()">
                                    <i class="fas fa-database"></i> Tablo ve Veri Oluştur
                                </button>
                                <button type="button" class="btn btn-info" onclick="debugExcel()">
                                    <i class="fas fa-bug"></i> Debug
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages"></div>

                <!-- Loading -->
                <div id="loading" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-3">Excel dosyası analiz ediliyor...</p>
                </div>

                <!-- Analysis Results -->
                <div id="analysisResults">
                    <!-- File Information -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Dosya Adı</h6>
                                    <p class="card-text" id="fileName">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Toplam Satır</h6>
                                    <p class="card-text" id="totalRows">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Toplam Sütun</h6>
                                    <p class="card-text" id="totalColumns">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Analiz Tarihi</h6>
                                    <p class="card-text" id="analysisDate">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Type Distribution -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-pie-chart"></i> Veri Tipi Dağılımı</h5>
                                </div>
                                <div class="card-body">
                                    <div id="dataTypeDistribution"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column Analysis -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-columns"></i> Sütun Analizi</h5>
                                </div>
                                <div class="card-body">
                                    <div id="columnAnalysis"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sample Data -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-table"></i> Örnek Veriler</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped sample-data-table">
                                            <thead id="sampleDataHeader">
                                            </thead>
                                            <tbody id="sampleDataBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAnalysis = null;
        let currentTableId = null;
        let currentSheetNames = [];

        // Sayfa yüklendiğinde veritabanı bağlantılarını yükle
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabaseConnections();
            
            // Dosya seçildiğinde sayfa adlarını yükle
            document.getElementById('excelFile').addEventListener('change', function() {
                if (this.files.length > 0) {
                    loadSheetNames(this.files[0]);
                }
            });
        });

        async function loadDatabaseConnections() {
            try {
                const response = await fetch('/api/DatabaseConnection/GetAll');
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('databaseConnection');
                    select.innerHTML = '<option value="">Varsayılan Bağlantı</option>';
                    
                    result.data.forEach(connection => {
                        const option = document.createElement('option');
                        option.value = connection.id;
                        option.textContent = `${connection.serverName}:${connection.port} - ${connection.databaseName}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Veritabanı bağlantıları yüklenirken hata:', error);
            }
        }

        async function loadSheetNames(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/ExcelAnalysis/get-sheet-names', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentSheetNames = result.data;
                    const select = document.getElementById('sheetSelect');
                    select.innerHTML = '';
                    
                    currentSheetNames.forEach((sheetName, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${index + 1}. ${sheetName}`;
                        select.appendChild(option);
                    });
                    
                    select.disabled = false;
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Sayfa adları yüklenirken hata:', error);
                showMessage('Sayfa adları yüklenirken hata oluştu.', 'error');
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            clearMessages();
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
            messagesDiv.appendChild(messageDiv);
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        async function analyzeExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            const sheetSelect = document.getElementById('sheetSelect');
            
            if (!file) {
                showMessage('Lütfen bir Excel dosyası seçin.', 'error');
                return;
            }

            showLoading();

            try {
                const formData = new FormData();
                formData.append('file', file);

                let url = '/api/ExcelAnalysis/analyze';
                if (sheetSelect.value !== '') {
                    url += `?sheetIndex=${sheetSelect.value}`;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentAnalysis = result.data;
                    displayAnalysisResults(result.data);
                    showMessage('Excel dosyası başarıyla analiz edildi.', 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage(`Analiz sırasında hata oluştu: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function createTableStructure() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            const sheetSelect = document.getElementById('sheetSelect');
            
            if (!file) {
                showMessage('Lütfen bir Excel dosyası seçin.', 'error');
                return;
            }

            showLoading();

            try {
                const formData = new FormData();
                formData.append('file', file);

                const databaseConnectionId = document.getElementById('databaseConnection').value;
                const description = document.getElementById('description').value;

                let url = '/api/ExcelAnalysis/create-table-structure';
                const params = new URLSearchParams();
                
                if (databaseConnectionId) {
                    params.append('databaseConnectionId', databaseConnectionId);
                }
                if (description) {
                    params.append('description', description);
                }
                if (sheetSelect.value !== '') {
                    params.append('sheetIndex', sheetSelect.value);
                }
                
                if (params.toString()) {
                    url += `?${params.toString()}`;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentTableId = result.data.table.id;
                    currentAnalysis = result.data.analysis;
                    displayAnalysisResults(result.data.analysis);
                    showMessage('Tablo yapısı başarıyla oluşturuldu.', 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage(`Tablo oluşturulurken hata oluştu: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function createTableWithData() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            const sheetSelect = document.getElementById('sheetSelect');
            
            if (!file) {
                showMessage('Lütfen bir Excel dosyası seçin.', 'error');
                return;
            }

            showLoading();

            try {
                const formData = new FormData();
                formData.append('file', file);

                const databaseConnectionId = document.getElementById('databaseConnection').value;
                const description = document.getElementById('description').value;

                let url = '/api/ExcelAnalysis/create-table';
                const params = new URLSearchParams();
                
                if (databaseConnectionId) {
                    params.append('databaseConnectionId', databaseConnectionId);
                }
                if (description) {
                    params.append('description', description);
                }
                if (sheetSelect.value !== '') {
                    params.append('sheetIndex', sheetSelect.value);
                }
                
                if (params.toString()) {
                    url += `?${params.toString()}`;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentTableId = result.data.table.id;
                    currentAnalysis = result.data.analysis;
                    displayAnalysisResults(result.data.analysis);
                    showMessage('Tablo başarıyla oluşturuldu ve veriler eklendi.', 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage(`Tablo oluşturulurken hata oluştu: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function debugExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            const sheetSelect = document.getElementById('sheetSelect');
            
            if (!file) {
                showMessage('Lütfen bir Excel dosyası seçin.', 'error');
                return;
            }

            showLoading();

            try {
                const formData = new FormData();
                formData.append('file', file);

                let url = '/api/ExcelAnalysis/debug';
                if (sheetSelect.value !== '') {
                    url += `?sheetIndex=${sheetSelect.value}`;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Display debug information in a modal or alert
                    const debugInfo = `
Dosya Bilgileri:
- Dosya Adı: ${result.debugInfo.fileName}
- Dosya Boyutu: ${result.debugInfo.fileSize} bytes
- İçerik Türü: ${result.debugInfo.contentType}

Sayfa Bilgileri:
- Sayfa Adları: ${result.sheetNames.join(', ')}
- Seçili Sayfa: ${result.selectedSheet.sheetName}
- Sayfa İndeksi: ${result.selectedSheet.sheetIndex}
- Veri Var mı: ${result.selectedSheet.hasData}

Örnek Hücreler (İlk 5x5):
${result.sampleCells.map(cell => 
    `Satır ${cell.row}, Sütun ${cell.col}: ${cell.hasValue ? cell.value : 'BOŞ'} (${cell.valueType || cell.cellType || 'N/A'})`
).join('\n')}
                    `;
                    
                    alert(debugInfo);
                    console.log('Debug result:', result);
                    showMessage('Debug bilgileri başarıyla alındı. Konsolu kontrol edin.', 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage(`Debug sırasında hata oluştu: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function displayAnalysisResults(analysis) {
            // Dosya bilgileri
            document.getElementById('fileName').textContent = analysis.fileName;
            document.getElementById('totalRows').textContent = analysis.totalRows.toLocaleString();
            document.getElementById('totalColumns').textContent = analysis.totalColumns;
            document.getElementById('analysisDate').textContent = new Date(analysis.analysisDate).toLocaleString('tr-TR');

            // Veri tipi dağılımı
            displayDataTypeDistribution(analysis.dataTypeAnalysis);

            // Sütun analizi
            displayColumnAnalysis(analysis.dataTypeAnalysis);

            // Örnek veriler
            displaySampleData(analysis.sampleData, analysis.headers);

            document.getElementById('analysisResults').style.display = 'block';
        }

        function displayDataTypeDistribution(dataTypeAnalysis) {
            const distribution = {};
            dataTypeAnalysis.forEach(analysis => {
                const dataType = analysis.detectedDataType;
                distribution[dataType] = (distribution[dataType] || 0) + 1;
            });

            const container = document.getElementById('dataTypeDistribution');
            container.innerHTML = '';

            Object.entries(distribution).forEach(([dataType, count]) => {
                const percentage = ((count / dataTypeAnalysis.length) * 100).toFixed(1);
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-primary data-type-badge">${dataType}</span>
                        <span>${count} sütun (${percentage}%)</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function displayColumnAnalysis(dataTypeAnalysis) {
            const container = document.getElementById('columnAnalysis');
            container.innerHTML = '';

            dataTypeAnalysis.forEach((analysis, index) => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'column-analysis';
                columnDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <h6>${analysis.columnName}</h6>
                            <span class="badge bg-primary data-type-badge">${analysis.detectedDataType}</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Güven: ${(analysis.confidence * 100).toFixed(1)}%</small>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${analysis.confidence * 100}%"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">
                                Boş: ${analysis.nullValues} | Dolu: ${analysis.nonNullValues}
                            </small>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <small class="text-muted">
                                Veri tipleri: Int(${analysis.intCount}) | Decimal(${analysis.decimalCount}) | 
                                Date(${analysis.dateCount}) | Bool(${analysis.boolCount}) | String(${analysis.stringCount})
                            </small>
                        </div>
                    </div>
                `;
                container.appendChild(columnDiv);
            });
        }

        function displaySampleData(sampleData, headers) {
            const headerRow = document.getElementById('sampleDataHeader');
            const body = document.getElementById('sampleDataBody');

            // Header
            headerRow.innerHTML = '';
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });

            // Data
            body.innerHTML = '';
            sampleData.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    const value = row[header];
                    if (value === null || value === undefined) {
                        td.textContent = '';
                        td.className = 'text-muted';
                    } else if (typeof value === 'object' && value instanceof Date) {
                        td.textContent = value.toLocaleDateString('tr-TR');
                    } else {
                        td.textContent = String(value);
                    }
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        }
    </script>
</body>
</html>
